{% extends 'main/face.html' %}
{% load static %}

{% block content %}

<!-- Add emoji picker library -->
<script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js" type="module"></script>
    
    <!-- Icon Libraries -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style type="text/css">
  /* WhatsApp-inspired chat room - Compact Enhanced Version */
  .chat-room-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    max-width: 100%;
    margin: 0;
    padding: 0;
    background: #e5ddd5;
    position: relative;
    overflow: hidden;
  }

  /* Multi-layer Watermark Design with Charity Themes - Enhanced Text Sizes */
  .chat-room-container::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400" opacity="0.04"><path d="M50,50 Q200,25 350,50" fill="none" stroke="%23075e54" stroke-width="2"/><path d="M25,200 Q175,175 325,200" fill="none" stroke="%23075e54" stroke-width="2"/><path d="M50,350 Q200,325 350,350" fill="none" stroke="%23075e54" stroke-width="2"/><text x="200" y="80" font-family="Arial" font-size="28" text-anchor="middle" fill="%23075e54" font-weight="bold">Together We Can</text><text x="200" y="120" font-family="Arial" font-size="22" text-anchor="middle" fill="%23075e54">Make a Difference</text><text x="200" y="160" font-family="Arial" font-size="18" text-anchor="middle" fill="%23075e54">Every Contribution Counts</text><text x="200" y="200" font-family="Arial" font-size="18" text-anchor="middle" fill="%23075e54">Fundraising for Change</text><text x="200" y="240" font-family="Arial" font-size="18" text-anchor="middle" fill="%23075e54">Support the Cause</text><text x="200" y="280" font-family="Arial" font-size="18" text-anchor="middle" fill="%23075e54">Give Hope</text><circle cx="200" cy="40" r="10" fill="%23075e54"/><circle cx="120" cy="350" r="8" fill="%23075e54"/><circle cx="280" cy="350" r="8" fill="%23075e54"/></svg>'),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="250" height="250" viewBox="0 0 250 250" opacity="0.03"><path d="M30,30 Q125,15 220,30" fill="none" stroke="%23128c7e" stroke-width="1.5"/><path d="M15,125 Q110,110 205,125" fill="none" stroke="%23128c7e" stroke-width="1.5"/><path d="M30,220 Q125,205 220,220" fill="none" stroke="%23128c7e" stroke-width="1.5"/><text x="125" y="60" font-family="Arial" font-size="18" text-anchor="middle" fill="%23128c7e">Charity</text><text x="125" y="90" font-family="Arial" font-size="16" text-anchor="middle" fill="%23128c7e">Compassion</text><text x="125" y="120" font-family="Arial" font-size="16" text-anchor="middle" fill="%23128c7e">Kindness</text><text x="125" y="170" font-family="Arial" font-size="16" text-anchor="middle" fill="%23128c7e">Empathy</text><text x="125" y="200" font-family="Arial" font-size="16" text-anchor="middle" fill="%23128c7e">Community</text><circle cx="125" cy="230" r="6" fill="%23128c7e"/></svg>'),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www/w3.org/2000/svg" width="180" height="180" viewBox="0 0 180 180" opacity="0.02"><path d="M20,20 Q90,10 160,20" fill="none" stroke="%2325d366" stroke-width="1"/><path d="M10,90 Q80,80 150,90" fill="none" stroke="%2325d366" stroke-width="1"/><path d="M20,160 Q90,150 160,160" fill="none" stroke="%2325d366" stroke-width="1"/><text x="90" y="50" font-family="Arial" font-size="14" text-anchor="middle" fill="%2325d366">Donate</text><text x="90" y="80" font-family="Arial" font-size="12" text-anchor="middle" fill="%2325d366">Volunteer</text><text x="90" y="110" font-family="Arial" font-size="12" text-anchor="middle" fill="%2325d366">Support</text><text x="90" y="150" font-family="Arial" font-size="12" text-anchor="middle" fill="%2325d366">Inspire</text><text x="90" y="170" font-family="Arial" font-size="12" text-anchor="middle" fill="%2325d366">Care</text></svg>');
    background-repeat: repeat;
    background-size: 400px 400px, 250px 250px, 180px 180px;
    pointer-events: none;
    z-index: 0;
  }

  /* Dark mode background with enhanced watermark */
  body.dark-mode .chat-room-container {
    background: #0d1418;
  }

  body.dark-mode .chat-room-container::before {
    background-image: 
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400" opacity="0.05"><path d="M50,50 Q200,25 350,50" fill="none" stroke="%2300af9c" stroke-width="2"/><path d="M25,200 Q175,175 325,200" fill="none" stroke="%2300af9c" stroke-width="2"/><path d="M50,350 Q200,325 350,350" fill="none" stroke="%2300af9c" stroke-width="2"/><text x="200" y="80" font-family="Arial" font-size="28" text-anchor="middle" fill="%2300af9c" font-weight="bold">Change Lives</text><text x="200" y="120" font-family="Arial" font-size="22" text-anchor="middle" fill="%2300af9c">Spread Hope</text><text x="200" y="160" font-family="Arial" font-size="18" text-anchor="middle" fill="%2300af9c">Fundraising Goals</text><text x="200" y="200" font-family="Arial" font-size="18" text-anchor="middle" fill="%2300af9c">Social Impact</text><text x="200" y="240" font-family="Arial" font-size="18" text-anchor="middle" fill="%2300af9c">Be the Change</text><text x="200" y="280" font-family="Arial" font-size="18" text-anchor="middle" fill="%2300af9c">Give Back</text><circle cx="200" cy="40" r="10" fill="%2300af9c"/><circle cx="120" cy="350" r="8" fill="%2300af9c"/><circle cx="280" cy="350" r="8" fill="%2300af9c"/></svg>'),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="250" height="250" viewBox="0 0 250 250" opacity="0.04"><path d="M30,30 Q125,15 220,30" fill="none" stroke="%2300e676" stroke-width="1.5"/><path d="M15,125 Q110,110 205,125" fill="none" stroke="%2300e676" stroke-width="1.5"/><path d="M30,220 Q125,205 220,220" fill="none" stroke="%2300e676" stroke-width="1.5"/><text x="125" y="60" font-family="Arial" font-size="18" text-anchor="middle" fill="%2300e676">Generosity</text><text x="125" y="90" font-family="Arial" font-size="16" text-anchor="middle" fill="%2300e676">Philanthropy</text><text x="125" y="120" font-family="Arial" font-size="16" text-anchor="middle" fill="%2300e676">Solidarity</text><text x="125" y="170" font-family="Arial" font-size="16" text-anchor="middle" fill="%2300e676">Advocacy</text><text x="125" y="200" font-family="Arial" font-size="16" text-anchor="middle" fill="%2300e676">Unity</text><circle cx="125" cy="230" r="6" fill="%2300e676"/></svg>'),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="180" height="180" viewBox="0 0 180 180" opacity="0.03"><path d="M20,20 Q90,10 160,20" fill="none" stroke="%2334b7f1" stroke-width="1"/><path d="M10,90 Q80,80 150,90" fill="none" stroke="%2334b7f1" stroke-width="1"/><path d="M20,160 Q90,150 160,160" fill="none" stroke="%2334b7f1" stroke-width="1"/><text x="90" y="50" font-family="Arial" font-size="14" text-anchor="middle" fill="%2334b7f1">Campaign</text><text x="90" y="80" font-family="Arial" font-size="12" text-anchor="middle" fill="%2334b7f1">Donations</text><text x="90" y="110" font-family="Arial" font-size="12" text-anchor="middle" fill="%2334b7f1">Awareness</text><text x="90" y="150" font-family="Arial" font-size="12" text-anchor="middle" fill="%2334b7f1">Empower</text><text x="90" y="170" font-family="Arial" font-size="12" text-anchor="middle" fill="%2334b7f1">Serve</text></svg>');
  }

  /* Make sure content is above watermark */
  .chat-header,
  .messages-container,
  .message-input-area,
  .participants-section,
  .management-section {
    position: relative;
    z-index: 1;
  }

  /* Chat Header */
  .chat-header {
    background: #075e54;
    color: white;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    z-index: 10;
    position: relative;
    flex-shrink: 0;
  }

  .chat-title {
    font-size: 18px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Chat messages area */
  .messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px 16px;
    background-image: url('{% static "images/whatsapp-bg.png" %}');
    background-size: contain;
    background-attachment: fixed;
    display: flex;
    flex-direction: column;
    -webkit-overflow-scrolling: touch;
  }

  .dark-mode .messages-container {
    background-image: url('{% static "images/whatsapp-bg-dark.png" %}');
  }

  /* Message container */
  .message-container {
    display: flex;
    margin-bottom: 8px;
    position: relative;
    animation: fadeIn 0.3s ease-out;
    align-items: flex-start;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Message bubbles */
  .message {
    max-width: 80%;
    padding: 8px 12px;
    border-radius: 7.5px;
    position: relative;
    word-wrap: break-word;
  }

  .own-message-container {
    justify-content: flex-end;
  }

  .own-message {
    background: #dcf8c6;
    border-top-right-radius: 0;
    margin-left: 20%;
  }

  .dark-mode .own-message {
    background: #056162;
    color: #e7e7e7;
  }

  .other-message-container {
    justify-content: flex-start;
  }

  .other-message {
    background: white;
    border-top-left-radius: 0;
    margin-right: 20%;
  }

  .dark-mode .other-message {
    background: #262d31;
    color: #e7e7e7;
  }

  /* Profile picture for other users */
  .message-profile-pic {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 8px;
    align-self: flex-start;
    margin-top: 4px;
  }

  /* Message metadata */
  .message-info {
    display: flex;
    justify-content: space-between;
    margin-top: 4px;
    font-size: 11px;
    color: #666;
  }

  .dark-mode .message-info {
    color: #a6a8aa;
  }

  .own-message .message-info {
    text-align: right;
  }

  /* Sender name */
  .sender-name {
    font-weight: bold;
    margin-bottom: 2px;
    color: #075e54;
  }

  .dark-mode .sender-name {
    color: #00af9c;
  }

  /* Profile pictures */
  .profile-pic {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 10px;
    border: 1px solid #eee;
  }

  /* Input area */
  .message-input-area {
    background: #f0f0f0;
    padding: 8px 16px;
    display: flex;
    align-items: center;
    border-top: 1px solid #ddd;
    flex-shrink: 0;
  }

  .dark-mode .message-input-area {
    background: #1e2428;
    border-top-color: #333;
  }

  .message-input {
    flex: 1;
    padding: 10px 15px;
    border-radius: 21px;
    border: none;
    outline: none;
    font-size: 15px;
    margin: 0 8px;
    background: white;
    box-shadow: 0 1px 1px rgba(0,0,0,0.08);
    min-height: 20px;
    max-height: 100px;
    overflow-y: auto;
    resize: none;
  }

  .dark-mode .message-input {
    background: #33383b;
    color: white;
  }

  .send-button {
    background: #075e54;
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
  }

  .send-button:hover {
    background: #054d44;
  }

  .dark-mode .send-button {
    background: #00af9c;
  }

  /* Participants section */
  .participants-section {
    background: white;
    padding: 12px 16px;
    border-bottom: 1px solid #eee;
    max-height: 50vh;
    overflow-y: auto;
  }

  .dark-mode .participants-section {
    background: #2a2f32;
    border-bottom-color: #333;
  }

  .participant {
    display: flex;
    align-items: center;
    padding: 8px 0;
  }

  /* Management sections */
  .management-section {
    background: white;
    padding: 15px;
    margin: 0;
    border-radius: 0;
    box-shadow: none;
    max-height: 60vh;
    overflow-y: auto;
  }

  .dark-mode .management-section {
    background: #2a2f32;
  }

  .management-section h4 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #075e54;
  }

  .dark-mode .management-section h4 {
    color: #00af9c;
  }

  .participant-checkbox {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
  }

  .dark-mode .participant-checkbox {
    border-bottom-color: #333;
  }

  .action-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    margin-top: 10px;
    width: 100%;
    box-sizing: border-box;
  }

  .add-btn {
    background: #4CAF50;
    color: white;
  }

  .remove-btn {
    background: #f44336;
    color: white;
  }

  .delete-btn {
    background: #f44336;
    color: white;
    margin-top: 20px;
  }

  /* Dropdown menu */
  .dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
    border-radius: 4px;
  }

  .dark-mode .dropdown-content {
    background-color: #333;
  }

  .dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
  }

  .dark-mode .dropdown-content a {
    color: white;
  }

  .dropdown-content a:hover {
    background-color: #f1f1f1;
  }

  .dark-mode .dropdown-content a:hover {
    background-color: #444;
  }

  .dropdown:hover .dropdown-content {
    display: block;
  }

  /* Success message */
  #successMessage {
    display: none;
    background: #4CAF50;
    color: white;
    padding: 8px 15px;
    border-radius: 4px;
    margin: 10px;
    text-align: center;
  }

  /* Spinner */
  .spinner {
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top: 2px solid white;
    width: 16px;
    height: 16px;
    animation: spin 1s linear infinite;
    display: inline-block;
    vertical-align: middle;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Date divider */
  .date-divider {
    text-align: center;
    margin: 10px 0;
    position: relative;
  }

  .date-divider span {
    background: rgba(225,245,254,0.7);
    padding: 4px 12px;
    border-radius: 14px;
    font-size: 12px;
    color: #607d8b;
    position: relative;
    z-index: 1;
  }

  .dark-mode .date-divider span {
    background: rgba(33,33,33,0.7);
    color: #b0bec5;
  }

  .date-divider:before {
    content: "";
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: rgba(0,0,0,0.1);
    z-index: 0;
  }

  /* Media display styles */
  .message-media-container {
    margin-top: 5px;
    max-width: 100%;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .message-media-container img,
  .message-media-container video {
    max-width: 100%;
    border-radius: 8px;
    max-height: 300px;
    object-fit: contain;
    display: block;
  }
  
  .message-file-container {
    padding: 10px;
    background: rgba(0,0,0,0.05);
    border-radius: 8px;
    margin-top: 5px;
  }
  
  .dark-mode .message-file-container {
    background: rgba(255,255,255,0.1);
  }
  
  .file-download-btn {
    display: inline-block;
    margin-top: 5px;
    padding: 5px 10px;
    background-color: #4CAF50;
    color: white;
    border-radius: 4px;
    font-size: 12px;
    text-decoration: none;
    cursor: pointer;
  }
  
  .file-icon {
    margin-right: 5px;
    vertical-align: middle;
    font-size: 16px;
  }

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .chat-room-container {
      height: 100vh;
      max-height: -webkit-fill-available;
    }
    
    .message {
      max-width: 85%;
    }
    
    .own-message {
      margin-left: 15%;
    }
    
    .other-message {
      margin-right: 15%;
    }
    
    .management-section {
      max-height: 50vh;
    }
    
    .participants-section {
      max-height: 50vh;
    }
    
    .message-input {
      font-size: 14px;
      padding: 8px 12px;
    }
    
    .profile-pic {
      width: 28px;
      height: 28px;
    }
    
    .message-profile-pic {
      width: 28px;
      height: 28px;
    }
  }
</style>
<style type="text/css">
  /* [All your existing CSS remains the same] */
  
  /* Image preview modal styles */
  .image-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    overflow: auto;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .image-modal.show {
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 1;
  }
  
  .modal-content {
    display: block;
    max-width: 90%;
    max-height: 90%;
    margin: auto;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
  }
  
  .close-modal {
    position: absolute;
    top: 20px;
    right: 30px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
  }
  
  .close-modal:hover {
    color: #bbb;
  }
  
  .modal-caption {
    position: absolute;
    bottom: 20px;
    left: 0;
    right: 0;
    text-align: center;
    color: white;
    padding: 10px;
    background: rgba(0, 0, 0, 0.5);
  }
  
  .download-image-btn {
    position: absolute;
    bottom: 70px;
    right: 30px;
    background-color: #075e54;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  }
  
  .dark-mode .download-image-btn {
    background-color: #00af9c;
  }
  
  /* Make images in messages clickable */
  .message-media-container {
    cursor: pointer;
    transition: transform 0.2s;
  }
  
  .message-media-container:hover {
    transform: scale(1.02);
  }
</style>

<style type="text/css">
  /* [All your existing CSS remains the same] */
  
  /* Emoji picker styles */
  emoji-picker {
    --num-columns: 8;
    --emoji-size: 24px;
    --border-radius: 8px;
    --category-emoji-size: 18px;
    --background: #fff;
    --border-color: #e0e0e0;
    --indicator-color: #075e54;
    --input-border-color: #e0e0e0;
    --input-font-size: 14px;
    --outline-size: 0;
    --category-font-size: 12px;
    --font-family: inherit;
    height: 300px;
    width: 100%;
    max-width: 350px;
    position: absolute;
    bottom: 60px;
    right: 10px;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    border-radius: 12px;
    display: none;
  }

  .dark-mode emoji-picker {
    --background: #2a2f32;
    --border-color: #444;
    --indicator-color: #00af9c;
    --input-border-color: #444;
    --text-color: #e7e7e7;
    --input-background: #33383b;
  }

  @media (max-width: 768px) {
    emoji-picker {
      max-width: 280px;
      right: 5px;
      bottom: 55px;
    }
  }
</style>

<!-- Image Preview Modal -->
<div id="imageModal" class="image-modal">
  <span class="close-modal">&times;</span>
  <img class="modal-content" id="modalImage">
  <div class="modal-caption" id="modalCaption"></div>
  <a id="downloadImageBtn" class="download-image-btn" download>
    <i class="material-icons">file_download</i>
  </a>
</div>

<div class="chat-room-container">
  <!-- Chat Header -->
  <div class="chat-header">
    <div class="chat-title">
      <img src="{{ chat.manager.profile.image.url }}" class="profile-pic" alt="{{ chat.manager.username }}">
      <div style="overflow: hidden;">
        <div style="overflow: hidden; text-overflow: ellipsis;">{{ chat.title }}</div>
        <div style="font-size: 12px;">
          {% if chat.participants.count == 1 %}
            1 participant
          {% else %}
            {{ chat.participants.count }} participants
          {% endif %}
        </div>
      </div>
    </div>
    <div class="dropdown">
      <i class="material-icons" style="cursor: pointer;">more_vert</i>
      <div class="dropdown-content">
        <a href="#" id="showParticipants">Show Participants</a>
        {% if chat.manager == user %}
          <a href="#" id="showManagement">Manage Chat</a>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Participants Section (Collapsible) -->
  <div class="participants-section" style="display: none;" id="participantsSection">
    <h4>Participants</h4>
    {% for participant in chat.participants.all %}
    <div class="participant">
      <img src="{{ participant.profile.image.url }}" class="profile-pic" alt="{{ participant.username }}">
      <div>
        <div>{{ participant.username }}</div>
        {% if participant.profile.profile_verified %}
        <div style="font-size: 12px; color: #4CAF50;">
          <i class="material-icons" style="font-size:12px;">verified_user</i> Verified
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- Management Section (Collapsible) -->
  {% if chat.manager == user %}
  <div class="management-section" style="display: none;" id="managementSection">
    <!-- Add Participants Form -->
    <h4>Add Participants</h4>
    <form method="post" action="{% url 'add_participants' chat.id %}" id="addParticipantsForm">
      {% csrf_token %}
      <div style="max-height: 30vh; overflow-y: auto;">
        {% for user_choice in user_choices %}
        <div class="participant-checkbox">
          <input type="checkbox" name="participants" value="{{ user_choice.pk }}" id="add-{{ user_choice.pk }}">
          <label for="add-{{ user_choice.pk }}" style="display: flex; align-items: center; gap: 8px; margin-left: 8px;">
            <img src="{{ user_choice.profile.image.url }}" class="profile-pic" alt="{{ user_choice.username }}">
            <span>{{ user_choice.username }}</span>
            {% if user_choice.profile.profile_verified %}
            <i class="material-icons" style="font-size:14px;color:green">verified_user</i>
            {% endif %}
          </label>
        </div>
        {% endfor %}
      </div>
      <button type="submit" class="action-btn add-btn">‚ûï Add Selected</button>
    </form>
    
    <hr style="margin: 15px 0; border-color: #eee;">
    
    <!-- Remove Participants Form -->
    <h4>Remove Participants</h4>
    <form method="post" action="{% url 'remove_participants' chat.id %}" id="removeParticipantsForm">
      {% csrf_token %}
      <div style="max-height: 30vh; overflow-y: auto;">
        {% for participant in chat.participants.all %}
        <div class="participant-checkbox">
          <input type="checkbox" name="participants" value="{{ participant.id }}" id="remove-{{ participant.id }}">
          <label for="remove-{{ participant.id }}" style="display: flex; align-items: center; gap: 8px; margin-left: 8px;">
            <img src="{{ participant.profile.image.url }}" class="profile-pic" alt="{{ participant.username }}">
            <span>{{ participant.username }}</span>
            {% if participant.profile.profile_verified %}
            <i class="material-icons" style="font-size:14px;color:green">verified_user</i>
            {% endif %}
          </label>
        </div>
        {% endfor %}
      </div>
      <button type="submit" class="action-btn remove-btn">‚ùå Remove Selected</button>
    </form>
    
    <!-- Delete Chat Form -->
    <form method="post" action="{% url 'delete_chat' chat.id %}" id="deleteChatForm">
      {% csrf_token %}
      <button type="submit" class="action-btn delete-btn">üóëÔ∏è Delete Chat</button>
    </form>
  </div>
  {% endif %}
   
  <!-- Messages Container - UPDATED WITH CLICKABLE IMAGES -->
  <div class="messages-container" id="messagesContainer">
    {% for message in messages %}
      {% ifchanged message.timestamp.date %}
        <div class="date-divider">
          <span>{{ message.timestamp|date:"F j, Y" }}</span>
        </div>
      {% endifchanged %}
      
      {% if message.sender == user %}
        <div class="message-container own-message-container">
          <div class="message own-message" id="message-{{ message.id }}" data-timestamp="{{ message.timestamp|date:'U' }}000">
            <div class="message-text">
              {% if message.file %}
                <!-- Display images and videos directly -->
                {% if message.file_type|slice:":5" == "image" %}
                  <div class="message-media-container" onclick="openImageModal('{{ message.file.url }}', '{{ message.sender.username }}', '{{ message.timestamp|date:"M j, Y" }}')">
                    <img src="{{ message.file.url }}" alt="Shared image">
                  </div>
                {% elif message.file_type|slice:":5" == "video" %}
                  <div class="message-media-container">
                    <video controls>
                      <source src="{{ message.file.url }}" type="{{ message.file_type }}">
                      Your browser does not support the video tag.
                    </video>
                  </div>
                {% else %}
                  <!-- For other file types, show download option -->
                  <div class="message-file-container">
                    <i class="material-icons file-icon">description</i>
                    <span>{{ message.file_name }}</span>
                    <a href="{{ message.file.url }}" download="{{ message.file_name }}" class="file-download-btn">
                      Download File
                    </a>
                  </div>
                {% endif %}
                
                {% if message.content and message.content != "say something.." %}
                  <div style="margin-top: 8px;">{{ message.content|safe }}</div>
                {% endif %}
              {% else %}
                {{ message.content|safe }}
              {% endif %}
            </div>
            
            <div class="message-info">
              <span class="message-time">{{ message.timestamp|time:"H:i" }}</span>
              <span class="message-status">
                <i class="material-icons" style="font-size:14px;"> done_all</i>
              </span>
            </div>
          </div>
        </div>
      {% else %}
        <div class="message-container other-message-container">
          <img src="{{ message.sender.profile.image.url }}" class="message-profile-pic" alt="{{ message.sender.username }}">
          <div class="message other-message" id="message-{{ message.id }}" data-timestamp="{{ message.timestamp|date:'U' }}000">
            <div class="sender-name">~ {{ message.sender.username }}</div>
            <div class="message-text">
              {% if message.file %}
                <!-- Display images and videos directly -->
                {% if message.file_type|slice:":5" == "image" %}
                  <div class="message-media-container" onclick="openImageModal('{{ message.file.url }}', '{{ message.sender.username }}', '{{ message.timestamp|date:"M j, Y" }}')">
                    <img src="{{ message.file.url }}" alt="Shared image">
                  </div>
                {% elif message.file_type|slice:":5" == "video" %}
                  <div class="message-media-container">
                    <video controls>
                      <source src="{{ message.file.url }}" type="{{ message.file_type }}">
                      Your browser does not support the video tag.
                    </video>
                  </div>
                {% else %}
                  <!-- For other file types, show download option -->
                  <div class="message-file-container">
                    <i class="material-icons file-icon">description</i>
                    <span>{{ message.file_name }}</span>
                    <a href="{{ message.file.url }}" download="{{ message.file_name }}" class="file-download-btn">
                      Download File
                    </a>
                  </div>
                {% endif %}
                
                {% if message.content and message.content != "say something.." %}
                  <div style="margin-top: 8px;">{{ message.content|safe }}</div>
                {% endif %}
              {% else %}
                {{ message.content|safe }}
              {% endif %}
            </div>
            
            <div class="message-info">
              <span class="message-time">{{ message.timestamp|time:"H:i" }}</span>
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>
  
  <!-- Success Message -->
  <div id="successMessage"></div>

    <!-- Emoji Picker -->
  <emoji-picker id="emojiPicker"></emoji-picker>
  
  <!-- Message Input Area -->
  <form id="chatForm" method="post" enctype="multipart/form-data" class="message-input-area">
    {% csrf_token %}
    
    <!-- File upload button -->
    <button class="send-button" style="background: transparent; color: #666;" id="fileButton" type="button">
      <i class="material-icons">attach_file</i>
    </button>
    <input type="file" id="fileInput" name="file" style="display: none;" accept="image/*,video/*,.pdf,.doc,.docx,.txt">
    
    <!-- Emoji button -->
    <button class="send-button" style="background: transparent; color: #666;" id="emojiButton" type="button">
      <i class="material-icons">insert_emoticon</i>
    </button>
    
    <!-- Message input -->
    <div style="flex: 1; display: flex;">
      <textarea class="message-input" id="messageInput" name="content" placeholder="Type a message..." rows="1"></textarea>
    </div>
    
    <!-- Send button -->
    <button type="button" class="send-button" id="sendButton">
      <i class="material-icons">send</i>
    </button>
  </form>
</div>
<style>
  .file-preview {
    background: rgba(0, 0, 0, 0.03) !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    border-radius: 8px !important;
    padding: 10px !important;
    margin: 10px 16px !important;
  }
  
  .dark-mode .file-preview {
    background: rgba(255, 255, 255, 0.05) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
  }
</style>

<!-- REMOVED JQUERY - Using pure JavaScript instead -->

<script>
// Global variables
let timeUpdaterInterval = null;
let filePreviewElement = null;
let selectedFile = null;

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  // ================== EMOJI PICKER FUNCTIONALITY ==================
  const picker = document.getElementById('emojiPicker');
  const emojiButton = document.getElementById('emojiButton');
  const messageInput = document.getElementById('messageInput');
  
  if (picker && emojiButton) {
    emojiButton.addEventListener('click', (e) => {
      e.preventDefault();
      if (picker.style.display === 'block') {
        picker.style.display = 'none';
      } else {
        picker.style.display = 'block';
        setTimeout(() => {
          document.addEventListener('click', hidePickerOnClickOutside);
        }, 10);
      }
    });
    
    picker.addEventListener('emoji-click', event => {
      const emoji = event.detail.unicode;
      const cursorPos = messageInput.selectionStart;
      const textBefore = messageInput.value.substring(0, cursorPos);
      const textAfter = messageInput.value.substring(cursorPos);
      
      messageInput.value = textBefore + emoji + textAfter;
      messageInput.selectionStart = cursorPos + emoji.length;
      messageInput.selectionEnd = cursorPos + emoji.length;
      messageInput.dispatchEvent(new Event('input'));
      messageInput.focus();
      picker.style.display = 'none';
      document.removeEventListener('click', hidePickerOnClickOutside);
    });
    
    function hidePickerOnClickOutside(event) {
      if (!picker.contains(event.target) && event.target !== emojiButton) {
        picker.style.display = 'none';
        document.removeEventListener('click', hidePickerOnClickOutside);
      }
    }
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && picker.style.display === 'block') {
        picker.style.display = 'none';
        document.removeEventListener('click', hidePickerOnClickOutside);
        messageInput.focus();
      }
    });
  }
  
  // ================== IMAGE MODAL FUNCTIONALITY ==================
  window.openImageModal = function(imageSrc, sender, timestamp) {
    const modal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImage");
    const captionText = document.getElementById("modalCaption");
    const downloadBtn = document.getElementById("downloadImageBtn");
    
    modal.classList.add("show");
    modalImg.src = imageSrc;
    downloadBtn.href = imageSrc;
    captionText.innerHTML = `Sent by ${sender} on ${timestamp}`;
    document.body.style.overflow = "hidden";
  }

  window.closeImageModal = function() {
    const modal = document.getElementById("imageModal");
    modal.classList.remove("show");
    document.body.style.overflow = "auto";
  }

  // Close modal handlers
  document.getElementById("imageModal").addEventListener("click", function(e) {
    if (e.target === this || e.target.classList.contains("close-modal")) {
      closeImageModal();
    }
  });

  document.addEventListener("keydown", function(e) {
    if (e.key === "Escape") {
      closeImageModal();
    }
  });

  // ================== CHAT FUNCTIONALITY ==================
  
  // Initialize
  updateAllMessageTimes();
  scrollToBottom();

  // Event Listeners
  document.getElementById('showParticipants').addEventListener('click', function(e) {
    e.preventDefault();
    toggleSection('participantsSection', 'managementSection');
  });

  if (document.getElementById('showManagement')) {
    document.getElementById('showManagement').addEventListener('click', function(e) {
      e.preventDefault();
      toggleSection('managementSection', 'participantsSection');
    });
  }

  document.getElementById('sendButton').addEventListener('click', sendMessage);
  
  document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.which == 13 && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Auto-resize textarea
  document.getElementById('messageInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });

  // File upload handling
  document.getElementById('fileButton').addEventListener('click', function() {
    document.getElementById('fileInput').click();
  });
  
  document.getElementById('fileInput').addEventListener('change', function() {
    if (this.files && this.files[0]) {
      const file = this.files[0];
      
      const allowedTypes = [
        'image/jpeg', 'image/png', 'image/gif', 
        'video/mp4', 'video/webm', 'video/ogg', 
        'application/pdf', 'text/plain', 'application/msword', 
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
      ];
      
      if (!allowedTypes.includes(file.type)) {
        alert('File type not allowed. Please upload images, videos, PDFs, or text documents.');
        this.value = '';
        return;
      }
      
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('File size too large. Maximum size is 10MB.');
        this.value = '';
        return;
      }
      
      selectedFile = file;
      showFilePreview(selectedFile);
    }
  });

  // Management form handlers
  const managementForms = ['addParticipantsForm', 'removeParticipantsForm', 'deleteChatForm'];
  managementForms.forEach(formId => {
    const form = document.getElementById(formId);
    if (form) {
      form.addEventListener('submit', handleManagementForm);
    }
  });

  // Start polling for new messages
  setInterval(pollForNewMessages, 3000);
  
  // Update times when page becomes visible
  document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
      updateMessageTimes();
    }
  });
});

// ================== HELPER FUNCTIONS ==================

function toggleSection(showId, hideId) {
  const showSection = document.getElementById(showId);
  const hideSection = document.getElementById(hideId);
  
  if (showSection.style.display === 'none' || showSection.style.display === '') {
    showSection.style.display = 'block';
    if (hideSection) hideSection.style.display = 'none';
  } else {
    showSection.style.display = 'none';
  }
  scrollToBottom();
}

function showFilePreview(file) {
  removeFilePreview();
  
  filePreviewElement = document.createElement('div');
  filePreviewElement.className = 'file-preview';
  
  const previewContent = document.createElement('div');
  previewContent.style.cssText = 'display: flex; align-items: center; gap: 10px;';
  
  const fileIcon = document.createElement('i');
  fileIcon.className = 'material-icons';
  fileIcon.textContent = 'insert_drive_file';
  
  const fileInfo = document.createElement('div');
  const fileName = document.createElement('div');
  fileName.textContent = file.name;
  fileName.style.cssText = 'font-weight: bold; font-size: 14px;';
  
  const fileSize = document.createElement('div');
  fileSize.textContent = formatFileSize(file.size);
  fileSize.style.cssText = 'font-size: 12px; color: #666;';
  
  const cancelButton = document.createElement('button');
  cancelButton.innerHTML = '<i class="material-icons">close</i>';
  cancelButton.style.cssText = 'background: transparent; border: none; cursor: pointer; color: #666; padding: 5px; margin-left: 10px;';
  cancelButton.onclick = function() {
    removeFilePreview();
    document.getElementById('fileInput').value = '';
  };
  
  fileInfo.appendChild(fileName);
  fileInfo.appendChild(fileSize);
  previewContent.appendChild(fileIcon);
  previewContent.appendChild(fileInfo);
  previewContent.appendChild(cancelButton);
  filePreviewElement.appendChild(previewContent);
  
  // Image preview
  if (file.type.startsWith('image/')) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const imgPreview = document.createElement('img');
      imgPreview.src = e.target.result;
      imgPreview.style.cssText = 'max-width: 60px; max-height: 60px; border-radius: 4px; object-fit: cover;';
      previewContent.insertBefore(imgPreview, previewContent.firstChild);
    };
    reader.readAsDataURL(file);
  }
  
  const messageInputArea = document.querySelector('.message-input-area');
  messageInputArea.parentNode.insertBefore(filePreviewElement, messageInputArea);
  
  document.getElementById('sendButton').innerHTML = '<i class="material-icons">file_upload</i>';
}

function removeFilePreview() {
  if (filePreviewElement && filePreviewElement.parentNode) {
    filePreviewElement.parentNode.removeChild(filePreviewElement);
    filePreviewElement = null;
  }
  selectedFile = null;
  document.getElementById('sendButton').innerHTML = '<i class="material-icons">send</i>';
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Main send message function
function sendMessage() {
  const content = document.getElementById('messageInput').value.trim();
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];
  const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
  
  if (!content && !file) {
    showSuccessMessage("Message cannot be empty", true);
    return;
  }

  const formData = new FormData();
  formData.append('csrfmiddlewaretoken', csrfToken);
  formData.append('content', content);
  if (file) {
    formData.append('file', file);
  }

  // Show loading state
  const sendButton = document.getElementById('sendButton');
  const originalHtml = sendButton.innerHTML;
  sendButton.innerHTML = '<span class="spinner"></span>';
  sendButton.disabled = true;

  fetch('{% url "send_message" chat.id %}', {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      document.getElementById('messageInput').value = "";
      document.getElementById('messageInput').style.height = 'auto';
      removeFilePreview();
      fileInput.value = '';
      
      if (data.message) {
        addMessageToChat(data.message);
        scrollToBottom();
      }
      showSuccessMessage("Message sent successfully!");
    } else {
      showSuccessMessage("Error: " + (data.error || "Unknown error"), true);
      console.error('Server error:', data.error);
    }
  })
  .catch(error => {
    showSuccessMessage("Error sending message: " + error, true);
    console.error('AJAX error:', error);
  })
  .finally(() => {
    sendButton.innerHTML = originalHtml;
    sendButton.disabled = false;
  });
}

function showSuccessMessage(message, isError = false) {
  const successDiv = document.getElementById('successMessage');
  successDiv.textContent = message;
  successDiv.style.background = isError ? '#f44336' : '#4CAF50';
  successDiv.style.display = 'block';
  setTimeout(() => {
    successDiv.style.display = 'none';
  }, 3000);
}

function addMessageToChat(messageData) {
  // Check if message already exists
  if (document.getElementById('message-' + messageData.id)) {
    return;
  }

  // Parse timestamp
  let messageDate;
  try {
    messageDate = new Date(messageData.timestamp);
    if (isNaN(messageDate.getTime())) {
      messageDate = new Date();
    }
  } catch (error) {
    messageDate = new Date();
  }
  
  const formattedDate = formatDate(messageDate);
  
  // Check if we need to add a date divider
  const dateDividers = document.querySelectorAll('.date-divider');
  const lastDateDivider = dateDividers[dateDividers.length - 1];
  const lastDate = lastDateDivider ? lastDateDivider.querySelector('span').textContent : '';
  
  if (lastDate !== formattedDate) {
    const dateDividerHtml = `
      <div class="date-divider">
        <span>${formattedDate}</span>
      </div>
    `;
    document.getElementById('messagesContainer').insertAdjacentHTML('beforeend', dateDividerHtml);
  }

  // Store timestamp
  const timestampAttr = messageDate.getTime();
  
  // Build message content based on file type
  let messageContent = '';
  
  if (messageData.file_url) {
    if (messageData.file_type && messageData.file_type.startsWith('image/')) {
      messageContent = `
        <div class="message-media-container" onclick="openImageModal('${messageData.file_url}', '${messageData.sender}', '${formatDate(messageDate)}')">
          <img src="${messageData.file_url}" alt="Shared image">
        </div>
      `;
    } else if (messageData.file_type && messageData.file_type.startsWith('video/')) {
      messageContent = `
        <div class="message-media-container">
          <video controls>
            <source src="${messageData.file_url}" type="${messageData.file_type}">
            Your browser does not support the video tag.
          </video>
        </div>
      `;
    } else {
      messageContent = `
        <div class="message-file-container">
          <i class="material-icons file-icon">description</i>
          <span>${messageData.file_name || 'File'}</span>
          <a href="${messageData.file_url}" download="${messageData.file_name || 'download'}" class="file-download-btn">
            Download File
          </a>
        </div>
      `;
    }
    
    if (messageData.content && messageData.content !== "say something..") {
      messageContent += `<div style="margin-top: 8px;">${messageData.content}</div>`;
    }
  } else {
    messageContent = `<div class="message-text">${messageData.content || ''}</div>`;
  }
  
  const isOwnMessage = messageData.is_own || messageData.sender === '{{ user.username }}';
  
  const messageHtml = `
    <div class="message-container ${isOwnMessage ? 'own-message-container' : 'other-message-container'}">
      ${!isOwnMessage ? `<img src="${messageData.sender_image}" class="message-profile-pic" alt="${messageData.sender}">` : ''}
      <div class="message ${isOwnMessage ? 'own-message' : 'other-message'}" id="message-${messageData.id}" data-timestamp="${timestampAttr}">
        ${!isOwnMessage ? `<div class="sender-name">~ ${messageData.sender}</div>` : ''}
        ${messageContent}
        <div class="message-info">
          <span class="message-time">${getRelativeTime(messageDate)}</span>
          ${isOwnMessage ? `<span class="message-status"><i class="material-icons" style="font-size:14px;">done_all</i></span>` : ''}
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('messagesContainer').insertAdjacentHTML('beforeend', messageHtml);
  
  const newMessage = document.getElementById('message-' + messageData.id);
  newMessage.style.display = 'none';
  setTimeout(() => {
    newMessage.style.display = '';
  }, 10);
  
  // Start time updater if not already running
  if (!timeUpdaterInterval) {
    startTimeUpdater();
  }
}

function formatDate(date) {
  if (isNaN(date.getTime())) {
    date = new Date();
  }
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  return months[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();
}

function getRelativeTime(date) {
  if (isNaN(date.getTime())) {
    return 'Just now';
  }
  
  const now = new Date();
  const diffInSeconds = Math.floor((now - date) / 1000);
  
  if (diffInSeconds < 10) return 'Just now';
  if (diffInSeconds < 60) return `${diffInSeconds} sec ago`;
  
  const diffInMinutes = Math.floor(diffInSeconds / 60);
  if (diffInMinutes < 60) return `${diffInMinutes} min ago`;
  
  const diffInHours = Math.floor(diffInMinutes / 60);
  if (diffInHours < 24) return `${diffInHours} hour${diffInHours !== 1 ? 's' : ''} ago`;
  
  const diffInDays = Math.floor(diffInHours / 24);
  if (diffInDays < 7) return `${diffInDays} day${diffInDays !== 1 ? 's' : ''} ago`;
  
  const diffInWeeks = Math.floor(diffInDays / 7);
  if (diffInWeeks < 4) return `${diffInWeeks} week${diffInWeeks !== 1 ? 's' : ''} ago`;
  
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  return `${months[date.getMonth()]} ${date.getDate()}`;
}

function updateAllMessageTimes() {
  document.querySelectorAll('.message').forEach(message => {
    const timestamp = message.getAttribute('data-timestamp');
    if (timestamp) {
      const messageDate = new Date(parseInt(timestamp));
      const timeElement = message.querySelector('.message-time');
      if (timeElement) {
        timeElement.textContent = getRelativeTime(messageDate);
      }
    }
  });
}

function startTimeUpdater() {
  if (timeUpdaterInterval) return;
  
  timeUpdaterInterval = setInterval(updateMessageTimes, 30000);
}

function updateMessageTimes() {
  document.querySelectorAll('.message').forEach(message => {
    const timestamp = message.getAttribute('data-timestamp');
    if (timestamp) {
      const messageDate = new Date(parseInt(timestamp));
      const timeElement = message.querySelector('.message-time');
      if (timeElement) {
        timeElement.textContent = getRelativeTime(messageDate);
      }
    }
  });
}

function scrollToBottom() {
  const container = document.getElementById('messagesContainer');
  container.scrollTop = container.scrollHeight;
}

// Poll for new messages
function pollForNewMessages() {
  const messages = document.querySelectorAll('.message');
  const lastMessage = messages[messages.length - 1];
  const lastMessageId = lastMessage ? lastMessage.id.replace('message-', '') : '0';
  
  if (lastMessageId === '0') return;

  fetch(window.location.href + '?last_message=' + lastMessageId, {
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.messages && data.messages.length > 0) {
      data.messages.forEach(function(message) {
        addMessageToChat(message);
      });
      scrollToBottom();
    }
  })
  .catch(error => {
    console.error('Polling error:', error);
  });
}

// Management form handler
function handleManagementForm(e) {
  e.preventDefault();
  const form = e.target;
  const button = form.querySelector('button[type="submit"]');
  const originalText = button.innerHTML;
  
  button.innerHTML = '<span class="spinner"></span> ' + originalText;
  button.disabled = true;

  const formData = new FormData(form);
  
  fetch(form.action, {
    method: 'POST',
    body: formData,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.redirect) {
      window.location.href = data.redirect;
    } else if (data.success) {
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
      button.innerHTML = originalText;
      button.disabled = false;
    }
  })
  .catch(error => {
    alert('An error occurred: ' + error);
    button.innerHTML = originalText;
    button.disabled = false;
  });
}
</script>

{% endblock %}