{% extends 'main/face.html' %}

{% block content %}

<style type="text/css">
    /* ===== MAIN CONTAINER ===== */
    .activity-form-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 16px rgba(29, 161, 242, 0.08);
        border: 1px solid #e1e8ed;
        margin: 20px auto;
        max-width: 600px;
        overflow: hidden;
    }
    
    /* ===== HEADER ===== */
    .activity-header {
        padding: 24px;
        background: linear-gradient(135deg, #1da1f2 0%, #1a8cd8 100%);
        color: white;
        position: relative;
    }
    
    .activity-header h1 {
        margin: 0;
        font-size: 22px;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .activity-header h1 i {
        font-size: 22px;
    }
    
    .activity-subtitle {
        margin: 8px 0 0 0;
        font-size: 15px;
        opacity: 0.95;
        font-weight: 400;
    }
    
    .close-btn {
        position: absolute;
        right: 20px;
        top: 20px;
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .close-btn:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    
    /* ===== BODY ===== */
    .activity-body {
        padding: 32px;
    }
    
    /* ===== PROGRESS INDICATOR ===== */
    .progress-indicator {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .progress-text {
        font-size: 14px;
        font-weight: 500;
    }
    
    .progress-count {
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
    }
    
    /* ===== CAMPAIGN PROGRESS CARD ===== */
    .campaign-progress-card {
        background: var(--bg-secondary);
        padding: 16px 24px;
        margin: 0 0 20px 0;
        border-radius: 12px;
        border: 1px solid var(--border-light);
    }
    
    .campaign-progress-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    
    .campaign-progress-title {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .campaign-progress-title i {
        color: var(--accent-color);
        margin-right: 8px;
    }
    
    .schedule-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .schedule-ahead {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border: 1px solid #10b981;
    }
    
    .schedule-behind {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid #ef4444;
    }
    
    .schedule-ontrack {
        background: rgba(29, 161, 242, 0.2);
        color: #1da1f2;
        border: 1px solid #1da1f2;
    }
    
    .progress-bar-container {
        margin-bottom: 12px;
    }
    
    .progress-bar-labels {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
    }
    
    .progress-bar-labels span {
        color: var(--text-secondary);
        font-size: 13px;
    }
    
    .progress-bar-bg {
        width: 100%;
        height: 6px;
        background: var(--border-light);
        border-radius: 3px;
        overflow: hidden;
    }
    
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #1DA1F2, #64B5F6);
        border-radius: 3px;
    }
    
    .campaign-time-info {
        display: flex;
        align-items: center;
        gap: 20px;
        padding-top: 8px;
        border-top: 1px solid var(--border-light);
        flex-wrap: wrap;
    }
    
    .time-info-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .time-info-item i {
        color: var(--text-secondary);
    }
    
    .time-info-item span {
        color: var(--text-secondary);
        font-size: 13px;
    }
    
    .time-info-item strong {
        color: var(--text-primary);
    }
    
    .time-warning {
        color: var(--warning-color) !important;
    }
    
    .time-danger {
        color: var(--danger-color) !important;
    }
    
    .time-success {
        color: var(--success-color) !important;
    }
    
    /* ===== LOCKED DAY WARNING ===== */
    .locked-day-warning {
        background: rgba(239, 68, 68, 0.1);
        border: 2px solid #ef4444;
        border-radius: 12px;
        padding: 16px;
        margin: 20px 0;
        display: flex;
        align-items: center;
        gap: 12px;
        animation: pulse-lock 2s infinite;
    }
    
    @keyframes pulse-lock {
        0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    
    .locked-icon-circle {
        width: 40px;
        height: 40px;
        background: #ef4444;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .locked-icon-circle i {
        color: white;
        font-size: 18px;
    }
    
    .locked-content {
        flex: 1;
    }
    
    .locked-title {
        color: #ef4444;
        font-size: 16px;
        font-weight: 700;
        display: block;
        margin-bottom: 4px;
    }
    
    .locked-description {
        color: var(--text-secondary);
        font-size: 14px;
        margin: 0;
    }
    
    .locked-badge {
        background: #ef4444;
        color: white;
        padding: 8px 16px;
        border-radius: 100px;
        font-size: 13px;
        font-weight: 600;
        white-space: nowrap;
    }
    
    /* ===== DURATION LIMIT STYLES ===== */
    .duration-limit-message {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 12px;
        padding: 24px;
        margin: 20px 0;
        color: white;
        text-align: center;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }
    
    .duration-limit-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }
    
    .duration-limit-title {
        font-size: 24px;
        font-weight: 800;
        margin-bottom: 8px;
    }
    
    .duration-limit-text {
        font-size: 16px;
        opacity: 0.95;
        margin-bottom: 20px;
    }
    
    .campaign-complete-badge {
        display: inline-block;
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 24px;
        border-radius: 100px;
        font-size: 14px;
        font-weight: 600;
    }
    
    .edit-only-note {
        background: #f0f9ff;
        border: 2px solid #bae6fd;
        border-radius: 12px;
        padding: 16px;
        margin: 20px 0;
        color: #0369a1;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .edit-only-note i {
        font-size: 20px;
        color: #0ea5e9;
    }
    
    /* ===== FORM SECTIONS ===== */
    .form-section {
        margin-bottom: 28px;
        padding: 24px;
        border: 2px solid #f0f4f8;
        border-radius: 12px;
        background: #fafbfd;
        transition: all 0.3s ease;
    }
    
    .form-section:hover {
        border-color: #e1e8ed;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .form-section.existing-activity {
        border-left: 4px solid #10b981;
        background: #f0f9ff;
    }
    
    .form-section.new-activity {
        border-left: 4px solid #1da1f2;
        background: #f0f9ff;
    }
    
    /* ===== FORM HEADERS ===== */
    .form-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px dashed #e1e8ed;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .form-title {
        display: flex;
        align-items: center;
        gap: 12px;
        color: #14171a;
        margin: 0;
        flex-wrap: wrap;
    }
    
    .activity-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: #1da1f2;
        color: white;
        border-radius: 50%;
        font-size: 13px;
        font-weight: 600;
    }
    
    .form-type-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .badge-existing {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
    }
    
    .badge-new {
        background: #e8f5fe;
        color: #1a8cd8;
        border: 1px solid #1da1f2;
    }
    
    .day-label {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-weight: 700;
    }
    
    .target-info {
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: normal;
    }
    
    .timestamp {
        font-size: 12px;
        color: #657786;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    /* ===== FORM ELEMENTS ===== */
    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #14171a;
        font-size: 15px;
    }
    
    .form-textarea, .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 12px;
        font-family: inherit;
        font-size: 15px;
        background-color: white;
        box-sizing: border-box;
        transition: all 0.2s ease;
    }
    
    .form-textarea:focus, .form-input:focus {
        outline: none;
        border-color: #1da1f2;
        box-shadow: 0 0 0 3px rgba(29, 161, 242, 0.1);
    }
    
    .form-textarea {
        min-height: 120px;
        resize: vertical;
        line-height: 1.5;
    }
    
    .form-helper {
        color: #657786;
        font-size: 13px;
        margin-top: 8px;
        display: block;
    }
    
    /* ===== EMOJI SECTION ===== */
    .emoji-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 12px 0;
        padding: 16px;
        background: #e8f5fe;
        border-radius: 12px;
        border: 1px solid rgba(29, 161, 242, 0.2);
    }
    
    .emoji-button {
        width: 40px;
        height: 40px;
        background: white;
        border: 2px solid #e1e8ed;
        border-radius: 10px;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .emoji-button:hover {
        transform: translateY(-2px);
        border-color: #1da1f2;
        background: #e8f5fe;
        box-shadow: 0 4px 8px rgba(29, 161, 242, 0.1);
    }
    
    .emoji-section {
        margin: 20px 0;
    }
    
    .emoji-section-label {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
        color: #1da1f2;
        font-weight: 600;
        font-size: 15px;
    }
    
    .emoji-section-label i {
        font-size: 18px;
    }
    
    /* ===== FILE UPLOAD ===== */
    .file-upload-area {
        border: 2px dashed #e1e8ed;
        border-radius: 12px;
        padding: 32px 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #fafbfd;
        margin-top: 12px;
        position: relative;
    }
    
    .file-upload-area:hover {
        border-color: #1da1f2;
        background: #e8f5fe;
    }
    
    .file-upload-icon {
        font-size: 28px;
        color: #1da1f2;
        margin-bottom: 12px;
    }
    
    .file-upload-text {
        font-size: 15px;
        color: #14171a;
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .file-input-hidden {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
        z-index: 2;
    }
    
    /* ===== FILE PREVIEW ===== */
    .file-preview-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
        margin-top: 16px;
    }
    
    .file-preview-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #e1e8ed;
        height: 120px;
    }
    
    .file-preview-item img,
    .file-preview-item video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }
    
    .audio-preview {
        padding: 20px;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        height: 100%;
    }
    
    .remove-file-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3;
    }
    
    .file-name {
        font-size: 12px;
        color: #657786;
        margin-top: 4px;
        word-break: break-word;
    }
    
    /* ===== DELETE CHECKBOX ===== */
    .delete-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
        padding: 12px 16px;
        background: #fff5f5;
        border-radius: 8px;
        border: 1px solid #feb2b2;
    }
    
    .delete-checkbox label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        color: #c53030;
        font-weight: 500;
        font-size: 14px;
    }
    
    /* ===== SUBMIT BUTTON ===== */
    .submit-button {
        background: linear-gradient(135deg, #1da1f2 0%, #1a8cd8 100%);
        color: white;
        border: none;
        border-radius: 12px;
        padding: 16px 32px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 32px auto 0;
        width: 100%;
        box-shadow: 0 4px 12px rgba(29, 161, 242, 0.2);
    }
    
    .submit-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(29, 161, 242, 0.3);
    }
    
    .submit-button i {
        margin-right: 10px;
        font-size: 16px;
    }
    
    .submit-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }
    
    /* ===== ERROR STYLES ===== */
    .error-container {
        background-color: rgba(224, 36, 94, 0.05);
        border-left: 4px solid #e0245e;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        color: #e0245e;
        font-size: 14px;
    }
    
    /* ===== GUIDANCE ===== */
    .emotional-guidance {
        background: #e8f5fe;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid rgba(29, 161, 242, 0.2);
    }
    
    .guidance-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
        color: #1da1f2;
    }
    
    .guidance-content {
        color: #14171a;
        font-size: 14px;
        line-height: 1.5;
    }
    
    /* ===== BACK BUTTON ===== */
    .back-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: white;
        border: 2px solid #e1e8ed;
        border-radius: 12px;
        color: #14171a;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
        margin: 20px auto;
        display: block;
        width: fit-content;
    }
    
    .back-button:hover {
        border-color: #1da1f2;
        background: #e8f5fe;
        transform: translateY(-2px);
    }
    
    /* ===== MAX LIMIT WARNING ===== */
    .max-limit-warning {
        background: #fff7ed;
        border: 2px solid #fed7aa;
        border-radius: 12px;
        padding: 16px;
        margin: 20px 0;
        color: #9a3412;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .max-limit-warning i {
        font-size: 20px;
        color: #f97316;
    }
    
    /* ===== FLEXIBILITY NOTE ===== */
    .flexibility-note {
        background: #f0f9ff;
        border: 2px solid #bae6fd;
        border-radius: 12px;
        padding: 16px;
        margin: 20px 0;
        color: #0369a1;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .flexibility-note i {
        font-size: 20px;
        color: #0ea5e9;
    }
    
    /* ===== CELEBRATION NOTE ===== */
    .celebration-note {
        background: rgba(16, 185, 129, 0.1);
        border: 2px solid #10b981;
        border-radius: 12px;
        padding: 16px;
        margin: 20px 0;
        color: #065f46;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .celebration-note i {
        font-size: 20px;
        color: #10b981;
    }
    
    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
        .activity-form-container {
            margin: 16px;
        }
        
        .activity-body {
            padding: 24px;
        }
        
        .activity-header {
            padding: 20px;
        }
        
        .activity-header h1 {
            font-size: 20px;
        }
        
        .form-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .timestamp {
            align-self: flex-start;
        }
        
        .emoji-button {
            width: 36px;
            height: 36px;
            font-size: 16px;
        }
        
        .file-preview-container {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
        
        .campaign-time-info {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        
        .locked-day-warning {
            flex-direction: column;
            text-align: center;
        }
        
        .locked-badge {
            width: 100%;
            text-align: center;
        }
    }

    /* ===== FIX FOR CONTENT TEXTAREA ===== */
    textarea.activity-content {
        width: 100% !important;
        min-height: 120px !important;
        max-height: 300px !important;
        resize: vertical !important;
        padding: 12px 16px !important;
        border: 2px solid #e1e8ed !important;
        border-radius: 12px !important;
        font-family: inherit !important;
        font-size: 15px !important;
        background-color: white !important;
        box-sizing: border-box !important;
        transition: all 0.2s ease !important;
        line-height: 1.5 !important;
    }
    
    textarea.activity-content:focus {
        outline: none !important;
        border-color: #1da1f2 !important;
        box-shadow: 0 0 0 3px rgba(29, 161, 242, 0.1) !important;
    }

    /* ===== DARK MODE DESIGN ===== */
    .dark-mode .activity-form-container {
        background: #15202b;
        border-radius: 16px;
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.3);
        border: 1px solid #38444d;
        margin: 20px auto;
        max-width: 600px;
        overflow: hidden;
    }

    .dark-mode .activity-header {
        padding: 24px;
        background: linear-gradient(135deg, #1da1f2 0%, #1a8cd8 100%);
        color: white;
        position: relative;
    }

    .dark-mode .activity-body {
        padding: 32px;
        background: #15202b;
    }

    .dark-mode .campaign-progress-card {
        background: #1e2a3a;
        border: 1px solid #38444d;
    }

    .dark-mode .campaign-progress-title {
        color: #ffffff;
    }

    .dark-mode .progress-bar-labels span {
        color: #a0aec0;
    }

    .dark-mode .progress-bar-bg {
        background: #2d3748;
    }

    .dark-mode .time-info-item span {
        color: #a0aec0;
    }

    .dark-mode .time-info-item strong {
        color: #ffffff;
    }

    .dark-mode .locked-day-warning {
        background: rgba(239, 68, 68, 0.15);
        border-color: #ef4444;
    }

    .dark-mode .locked-description {
        color: #a0aec0;
    }

    .dark-mode .duration-limit-message {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .dark-mode .edit-only-note {
        background: rgba(29, 161, 242, 0.1);
        border: 2px solid #63b3ed;
        color: #bee3f8;
    }

    .dark-mode .form-section {
        margin-bottom: 28px;
        padding: 24px;
        border: 2px solid #2d3748;
        border-radius: 12px;
        background: #1e2a3a;
        transition: all 0.3s ease;
    }

    .dark-mode .form-section:hover {
        border-color: #4a5568;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .dark-mode .form-section.existing-activity {
        border-left: 4px solid #10b981;
        background: rgba(16, 185, 129, 0.1);
    }

    .dark-mode .form-section.new-activity {
        border-left: 4px solid #1da1f2;
        background: rgba(29, 161, 242, 0.1);
    }

    .dark-mode .form-header {
        border-bottom: 2px dashed #4a5568;
    }

    .dark-mode .form-title {
        color: #ffffff;
    }

    .dark-mode .activity-number {
        background: #1da1f2;
    }

    .dark-mode .badge-existing {
        background: rgba(16, 185, 129, 0.2);
        color: #34d399;
        border: 1px solid #10b981;
    }

    .dark-mode .badge-new {
        background: rgba(29, 161, 242, 0.2);
        color: #90cdf4;
        border: 1px solid #1da1f2;
    }

    .dark-mode .target-info {
        color: #a0aec0;
    }

    .dark-mode .timestamp {
        color: #a0aec0;
    }

    .dark-mode .form-label {
        color: #e2e8f0;
    }

    .dark-mode .form-textarea,
    .dark-mode .form-input {
        border: 2px solid #4a5568;
        background-color: #2d3748;
        color: #e2e8f0;
    }

    .dark-mode .form-textarea:focus,
    .dark-mode .form-input:focus {
        border-color: #1da1f2;
        box-shadow: 0 0 0 3px rgba(29, 161, 242, 0.2);
    }

    .dark-mode .form-helper {
        color: #a0aec0;
    }

    .dark-mode .emoji-container {
        background: rgba(29, 161, 242, 0.15);
        border: 1px solid rgba(29, 161, 242, 0.3);
    }

    .dark-mode .emoji-button {
        background: #2d3748;
        border: 2px solid #4a5568;
    }

    .dark-mode .emoji-button:hover {
        border-color: #1da1f2;
        background: rgba(29, 161, 242, 0.2);
    }

    .dark-mode .emoji-section-label {
        color: #1da1f2;
    }

    .dark-mode .file-upload-area {
        border: 2px dashed #4a5568;
        background: rgba(255, 255, 255, 0.05);
    }

    .dark-mode .file-upload-area:hover {
        border-color: #1da1f2;
        background: rgba(29, 161, 242, 0.1);
    }

    .dark-mode .file-upload-text {
        color: #e2e8f0;
    }

    .dark-mode .file-preview-item {
        border: 2px solid #4a5568;
        background: #2d3748;
    }

    .dark-mode .audio-preview {
        background: #2d3748;
    }

    .dark-mode .file-name {
        color: #a0aec0;
    }

    .dark-mode .delete-checkbox {
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid #fc8181;
    }

    .dark-mode .delete-checkbox label {
        color: #fc8181;
    }

    .dark-mode .submit-button {
        background: linear-gradient(135deg, #1da1f2 0%, #1a8cd8 100%);
    }

    .dark-mode .error-container {
        background-color: rgba(224, 36, 94, 0.1);
        border-left: 4px solid #f56565;
        color: #f56565;
    }

    .dark-mode .emotional-guidance {
        background: rgba(29, 161, 242, 0.15);
        border: 1px solid rgba(29, 161, 242, 0.3);
    }

    .dark-mode .guidance-header {
        color: #1da1f2;
    }

    .dark-mode .guidance-content {
        color: #e2e8f0;
    }

    .dark-mode .back-button {
        background: #2d3748;
        border: 2px solid #4a5568;
        color: #e2e8f0;
    }

    .dark-mode .back-button:hover {
        border-color: #1da1f2;
        background: rgba(29, 161, 242, 0.2);
    }

    .dark-mode .max-limit-warning {
        background: rgba(251, 146, 60, 0.1);
        border: 2px solid #ed8936;
        color: #feebc8;
    }

    .dark-mode .flexibility-note {
        background: rgba(29, 161, 242, 0.1);
        border: 2px solid #63b3ed;
        color: #bee3f8;
    }

    .dark-mode .celebration-note {
        background: rgba(16, 185, 129, 0.1);
        border: 2px solid #10b981;
        color: #d1fae5;
    }

    .dark-mode textarea.activity-content {
        border: 2px solid #4a5568 !important;
        background-color: #2d3748 !important;
        color: #e2e8f0 !important;
    }

    .dark-mode textarea.activity-content:focus {
        border-color: #1da1f2 !important;
        box-shadow: 0 0 0 3px rgba(29, 161, 242, 0.2) !important;
    }

    .dark-mode ::placeholder {
        color: #718096;
    }
</style>

<!-- MAIN CONTAINER -->
<div class="activity-form-container">
    <div class="activity-header">
        <div>
            <h1>
                <i class="fas fa-tasks"></i>
                {% if existing_activities_count > 0 %}
                    {% if campaign.duration and existing_activities_count >= campaign.duration %}
                        Journey Complete! ðŸŽ‰
                    {% else %}
                        Continue Your Journey
                    {% endif %}
                {% else %}
                    Start Your Journey
                {% endif %}
            </h1>
            <p class="activity-subtitle">
                {% if existing_activities_count > 0 %}
                    {% if campaign.duration and existing_activities_count >= campaign.duration %}
                        You've completed all {{ campaign.duration }} days of "{{ campaign.title }}"
                    {% else %}
                        Day {{ existing_activities_count }} of {{ campaign.title }}
                    {% endif %}
                {% else %}
                    Begin sharing your story for "{{ campaign.title }}"
                {% endif %}
            </p>
        </div>
        <button class="close-btn" onclick="window.history.back()">&times;</button>
    </div>

    <div class="activity-body">
        <!-- CAMPAIGN PROGRESS CARD -->
        <div class="campaign-progress-card">
            <div class="campaign-progress-header">
                <h4 class="campaign-progress-title">
                    <i class="fas fa-flag-checkered"></i>
                    {{ campaign.title }}
                </h4>
                
                {% if campaign.duration %}
                    {% if schedule_status == 'ahead' %}
                        <span class="schedule-badge schedule-ahead">
                            <i class="fas fa-rocket"></i> {{ schedule_diff }} ahead
                        </span>
                    {% elif schedule_status == 'behind' %}
                        <span class="schedule-badge schedule-behind">
                            <i class="fas fa-exclamation-triangle"></i> {{ schedule_diff }} behind
                        </span>
                    {% else %}
                        <span class="schedule-badge schedule-ontrack">
                            <i class="fas fa-check-circle"></i> On track
                        </span>
                    {% endif %}
                {% endif %}
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-bar-container">
                <div class="progress-bar-labels">
                    <span>
                        <i class="fas fa-calendar-alt"></i> Day {{ existing_activities_count }}
                        {% if campaign.duration %}
                            / {{ campaign.duration }}
                        {% endif %}
                    </span>
                    <span>{{ progress_percentage|floatformat:1 }}%</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width: {{ progress_percentage }}%;"></div>
                </div>
            </div>
            
            <!-- Time Remaining Info -->
            <div class="campaign-time-info">
                {% if campaign.duration %}
                    {% if campaign.days_left is not None %}
                        <div class="time-info-item">
                            <i class="far fa-hourglass-half {% if campaign.days_left < 3 %}time-danger{% elif campaign.days_left < 7 %}time-warning{% else %}time-success{% endif %}"></i>
                            <span>
                                <strong class="{% if campaign.days_left < 3 %}time-danger{% elif campaign.days_left < 7 %}time-warning{% endif %}">{{ campaign.days_left }}</strong> 
                                {% if campaign.duration_unit == 'minutes' %}minutes{% else %}days{% endif %} left
                            </span>
                        </div>
                    {% endif %}
                    
                    {% if campaign.end_date %}
                        <div class="time-info-item">
                            <i class="far fa-calendar-check"></i>
                            <span>Ends: {{ campaign.end_date|date:"M d, Y" }}</span>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="time-info-item">
                        <i class="fas fa-infinity time-success"></i>
                        <span>Ongoing journey - no time limit</span>
                    </div>
                {% endif %}
                
                <!-- Current Real Day Indicator -->
                <div class="time-info-item">
                    <i class="fas fa-clock"></i>
                    <span>Current day: <strong>Day {{ current_real_day|floatformat:0 }}</strong></span>
                </div>
            </div>
        </div>
        
        <!-- DURATION LIMIT CHECK - IF USER HAS REACHED MAXIMUM CAMPAIGN DURATION -->
        {% if campaign.duration and existing_activities_count >= campaign.duration %}
            <!-- CAMPAIGN COMPLETE - CLEAR MESSAGE AND EDIT-ONLY MODE -->
            <div class="duration-limit-message">
                <div class="duration-limit-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="duration-limit-title">Journey Complete! ðŸŽ‰</div>
                <div class="duration-limit-text">
                    You've successfully completed all {{ campaign.duration }} days of "{{ campaign.title }}".
                    Thank you for sharing your journey with us!
                </div>
                <span class="campaign-complete-badge">
                    <i class="fas fa-check-circle"></i> 100% Complete
                </span>
            </div>
            
            <div class="edit-only-note">
                <i class="fas fa-pencil-alt"></i>
                <div>
                    <strong>Edit Mode Only:</strong> You've reached the maximum campaign duration. 
                    No new days can be added, but you can still edit your existing entries below.
                </div>
            </div>
            
            <!-- Display only existing forms for editing - NO NEW FORM -->
            {% if formset %}
                <form method="post" enctype="multipart/form-data" id="activityForm">
                    {% csrf_token %}
                    
                    {{ formset.management_form }}
                    
                    {% if formset.errors %}
                        <div class="error-container">
                            <strong>Please fix these errors:</strong>
                            <ul>
                                {% for form in formset %}
                                    {% for field in form %}
                                        {% for error in field.errors %}
                                            <li>
                                                {% if form.instance.pk %}
                                                    Day {{ forloop.parentloop.parentloop.counter }}
                                                {% else %}
                                                    New Day
                                                {% endif %}
                                                - {{ field.label }}: {{ error }}
                                            </li>
                                        {% endfor %}
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    
                    <!-- Loop through forms but only display existing ones -->
                    {% for form in formset %}
                        {% if form.instance.pk %}
                            <div class="form-section existing-activity" 
                                 id="activity-form-{{ forloop.counter0 }}" 
                                 data-form-index="{{ forloop.counter0 }}">
                                
                                <!-- FORM HEADER -->
                                <div class="form-header">
                                    <h3 class="form-title">
                                        <span class="activity-number">{{ forloop.counter }}</span>
                                        <span class="day-label">
                                            Day {{ forloop.counter }}
                                            {% if campaign.duration %}
                                                <span class="target-info">
                                                    of {{ campaign.duration }}
                                                </span>
                                            {% endif %}
                                        </span>
                                        <span class="form-type-badge badge-existing">
                                            <i class="fas fa-check-circle"></i> Completed
                                        </span>
                                    </h3>
                                    
                                    <div class="timestamp">
                                        <i class="far fa-clock"></i>
                                        {{ form.instance.timestamp|date:"M d, Y" }}
                                    </div>
                                </div>
                                
                                <!-- HIDDEN FIELDS -->
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                
                                <!-- DELETE CHECKBOX -->
                                {% if form.DELETE %}
                                <div class="delete-checkbox">
                                    <label>
                                        {{ form.DELETE }}
                                        <i class="fas fa-trash-alt"></i>
                                        Delete Day {{ forloop.counter }}
                                    </label>
                                </div>
                                {% endif %}
                                
                                <!-- CONTENT FIELD -->
                                <div style="margin-bottom: 20px;">
                                    <label class="form-label">
                                        Update your Day {{ forloop.counter }} message (optional):
                                    </label>
                                    {{ form.content }}
                                    <span class="form-helper">
                                        Edit your message or leave as is
                                    </span>
                                    
                                    <!-- EMOJI SECTION -->
                                    <div class="emoji-section">
                                        <div class="emoji-section-label">
                                            <i class="fas fa-smile"></i>
                                            Update feeling for Day {{ forloop.counter }} (optional)
                                        </div>
                                        
                                        <div class="emoji-container" id="emojiContainer-{{ forloop.counter0 }}">
                                            {% for emoji in initial_emojis %}
                                                <button type="button" 
                                                        class="emoji-button" 
                                                        onclick="addEmojiToField('{{ emoji }}', {{ forloop.parentloop.counter0 }})">
                                                    {{ emoji }}
                                                </button>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- MEDIA FIELD -->
                                <div>
                                    <label class="form-label">
                                        Update media for Day {{ forloop.counter }} (optional):
                                    </label>
                                    
                                    <!-- FILE UPLOAD AREA -->
                                    <div class="file-upload-area" id="drop-area-{{ forloop.counter0 }}">
                                        <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                                        <div class="file-upload-text">
                                            {% if form.instance.file %}
                                                Replace current file
                                            {% else %}
                                                Upload image, video, or audio
                                            {% endif %}
                                        </div>
                                        <span class="form-helper">Click or drag & drop (max 10MB)</span>
                                        <input type="file" 
                                               class="file-input-hidden" 
                                               id="file-input-{{ forloop.counter0 }}"
                                               accept="image/*,video/*,audio/*"
                                               onchange="handleFileSelect({{ forloop.counter0 }})">
                                    </div>
                                    
                                    <!-- HIDDEN DJANGO FILE FIELD -->
                                    {{ form.file }}
                                    
                                    <!-- FILE PREVIEW AREA -->
                                    <div id="file-preview-{{ forloop.counter0 }}" class="file-preview-container"></div>
                                    
                                    <!-- EXISTING FILE -->
                                    {% if form.instance.file %}
                                    <div id="existing-file-{{ forloop.counter0 }}" class="file-preview-container" style="margin-top: 10px;">
                                        <div style="width: 100%;">
                                            <div class="file-preview-item">
                                                {% if form.instance.file.url|lower|slice:'-4:' in '.jpg,.jpeg,.png,.gif,.bmp,.webp' %}
                                                    <img src="{{ form.instance.file.url }}" alt="Day {{ forloop.counter }} image">
                                                {% elif form.instance.file.url|lower|slice:'-4:' in '.mp4,.mov,.avi,.webm,.mkv' %}
                                                    <video controls style="width:100%;height:100%;">
                                                        <source src="{{ form.instance.file.url }}">
                                                    </video>
                                                {% elif form.instance.file.url|lower|slice:'-4:' in '.mp3,.wav,.ogg,.m4a' %}
                                                    <div class="audio-preview">
                                                        <i class="fas fa-music" style="font-size: 24px; color: #1da1f2;"></i>
                                                        <audio controls style="width: 100%; margin-top: 8px;">
                                                            <source src="{{ form.instance.file.url }}">
                                                        </audio>
                                                    </div>
                                                {% else %}
                                                    <div class="audio-preview">
                                                        <i class="fas fa-file" style="font-size: 24px; color: #657786;"></i>
                                                        <div style="font-size: 12px; margin-top: 8px;">Day {{ forloop.counter }} file</div>
                                                    </div>
                                                {% endif %}
                                                <button type="button" class="remove-file-btn" onclick="removeExistingFile({{ forloop.counter0 }})">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            <div class="file-name">
                                                {% if form.instance.file.name|length > 20 %}
                                                    {{ form.instance.file.name|slice:":17" }}...
                                                {% else %}
                                                    {{ form.instance.file.name }}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if not forloop.last %}
                            <hr style="border: none; border-top: 2px dashed #e1e8ed; margin: 32px 0;">
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    
                    <!-- SUBMIT BUTTON - EDIT ONLY -->
                    <button type="submit" class="submit-button" id="submitBtn">
                        <i class="fas fa-save"></i>
                        Save Changes to Completed Journey
                    </button>
                    
                    <div style="text-align: center; margin-top: 24px; color: #10b981; font-size: 14px; line-height: 1.5;">
                        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                        <strong>Journey complete!</strong> You can still edit your previous entries.
                    </div>
                </form>
            {% endif %}
            
        {% else %}
            <!-- NORMAL BEHAVIOR - CAMPAIGN STILL IN PROGRESS -->
            
            <!-- LOCKED DAY WARNING - Show if next day is locked -->
            {% if is_next_day_locked %}
            <div class="locked-day-warning">
                <div class="locked-icon-circle">
                    <i class="fas fa-lock"></i>
                </div>
                <div class="locked-content">
                    <strong class="locked-title">Day {{ next_available_day }} is locked</strong>
                    <p class="locked-description">
                        This day will be available in <strong>{{ days_until_unlock }} day{% if days_until_unlock > 1 %}s{% endif %}</strong>. 
                        You can only post updates for days that have actually arrived in real-time.
                    </p>
                </div>
                <div class="locked-badge">
                    <i class="far fa-clock"></i> {{ days_until_unlock }}d left
                </div>
            </div>
            {% endif %}
            
            <!-- MAX LIMIT WARNING - If we're approaching the limit -->
            {% if is_at_max %}
            <div class="max-limit-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>Maximum days reached ({{ max_forms }})</strong><br>
                    You've completed your {{ max_forms }}-day journey. Congratulations! ðŸŽ‰
                </div>
            </div>
            {% endif %}
            
            <!-- FLEXIBILITY NOTE -->
            <div class="flexibility-note">
                <i class="fas fa-check-circle"></i>
                <div>
                    <strong>Real-time journey:</strong> You can only post for days that have actually arrived. 
                    Future days are locked until their time comes.
                </div>
            </div>
            
            <!-- GUIDANCE -->
            <div class="emotional-guidance">
                <div class="guidance-header">
                    <i class="fas fa-lightbulb"></i>
                    <strong>How Your Journey Works</strong>
                </div>
                <div class="guidance-content">
                    {% if existing_activities_count == 0 %}
                        <strong>Today:</strong> Create Day 1 of your journey<br>
                        <strong>Tomorrow:</strong> Day 2 becomes available<br>
                        <strong>Each day:</strong> A new day unlocks in real-time
                    {% elif is_next_day_locked %}
                        <strong>Current day:</strong> Day {{ existing_activities_count }} completed<br>
                        <strong>Next unlock:</strong> Day {{ next_available_day }} in {{ days_until_unlock }} days<br>
                        <strong>Come back then:</strong> to continue your journey
                    {% else %}
                        <strong>Today's opportunity:</strong> Day {{ next_available_day }} is now available!<br>
                        <strong>Share your update:</strong> before the next day arrives<br>
                        <strong>Stay consistent:</strong> Each day builds your story
                    {% endif %}
                </div>
            </div>
            
            <!-- FORM START - Regular form with both existing and new forms -->
            {% if formset %}
            <form method="post" enctype="multipart/form-data" id="activityForm">
                {% csrf_token %}
                
                {{ formset.management_form }}
                
                {% if formset.errors %}
                    <div class="error-container">
                        <strong>Please fix these errors:</strong>
                        <ul>
                            {% for form in formset %}
                                {% for field in form %}
                                    {% for error in field.errors %}
                                        <li>
                                            {% if form.instance.pk %}
                                                Day {{ forloop.parentloop.parentloop.counter }}
                                            {% else %}
                                                New Day
                                            {% endif %}
                                            - {{ field.label }}: {{ error }}
                                        </li>
                                    {% endfor %}
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                
                <!-- FORMSET LOOP - Existing code for regular behavior -->
                {% for form in formset %}
                    {% with form_index=forloop.counter0 is_existing=form.instance.pk %}
                    
                    {% if is_existing %}
                        <!-- EXISTING ACTIVITY (always unlocked) -->
                        <div class="form-section existing-activity" 
                             id="activity-form-{{ form_index }}" 
                             data-form-index="{{ form_index }}">
                            
                            <!-- FORM HEADER -->
                            <div class="form-header">
                                <h3 class="form-title">
                                    <span class="activity-number">{{ forloop.counter }}</span>
                                    <span class="day-label">
                                        Day {{ forloop.counter }}
                                        {% if campaign.duration %}
                                            <span class="target-info">
                                                of {{ campaign.duration }}
                                            </span>
                                        {% endif %}
                                    </span>
                                    <span class="form-type-badge badge-existing">
                                        <i class="fas fa-check-circle"></i> Completed
                                    </span>
                                </h3>
                                
                                <div class="timestamp">
                                    <i class="far fa-clock"></i>
                                    {{ form.instance.timestamp|date:"M d, Y" }}
                                </div>
                            </div>
                            
                            <!-- HIDDEN FIELDS -->
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                            
                            <!-- DELETE CHECKBOX -->
                            {% if form.DELETE %}
                            <div class="delete-checkbox">
                                <label>
                                    {{ form.DELETE }}
                                    <i class="fas fa-trash-alt"></i>
                                    Delete Day {{ forloop.counter }}
                                </label>
                            </div>
                            {% endif %}
                            
                            <!-- CONTENT FIELD -->
                            <div style="margin-bottom: 20px;">
                                <label class="form-label">
                                    Update your Day {{ forloop.counter }} message (optional):
                                </label>
                                {{ form.content }}
                                <span class="form-helper">
                                    Edit your message or leave as is
                                </span>
                                
                                <!-- EMOJI SECTION -->
                                <div class="emoji-section">
                                    <div class="emoji-section-label">
                                        <i class="fas fa-smile"></i>
                                        Update feeling for Day {{ forloop.counter }} (optional)
                                    </div>
                                    
                                    <div class="emoji-container" id="emojiContainer-{{ form_index }}">
                                        {% for emoji in initial_emojis %}
                                            <button type="button" 
                                                    class="emoji-button" 
                                                    onclick="addEmojiToField('{{ emoji }}', {{ form_index }})">
                                                {{ emoji }}
                                            </button>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- MEDIA FIELD -->
                            <div>
                                <label class="form-label">
                                    Update media for Day {{ forloop.counter }} (optional):
                                </label>
                                
                                <!-- FILE UPLOAD AREA -->
                                <div class="file-upload-area" id="drop-area-{{ form_index }}">
                                    <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                                    <div class="file-upload-text">
                                        {% if form.instance.file %}
                                            Replace current file
                                        {% else %}
                                            Upload image, video, or audio
                                        {% endif %}
                                    </div>
                                    <span class="form-helper">Click or drag & drop (max 10MB)</span>
                                    <input type="file" 
                                           class="file-input-hidden" 
                                           id="file-input-{{ form_index }}"
                                           accept="image/*,video/*,audio/*"
                                           onchange="handleFileSelect({{ form_index }})">
                                </div>
                                
                                <!-- HIDDEN DJANGO FILE FIELD -->
                                {{ form.file }}
                                
                                <!-- FILE PREVIEW AREA -->
                                <div id="file-preview-{{ form_index }}" class="file-preview-container"></div>
                                
                                <!-- EXISTING FILE -->
                                {% if form.instance.file %}
                                <div id="existing-file-{{ form_index }}" class="file-preview-container" style="margin-top: 10px;">
                                    <div style="width: 100%;">
                                        <div class="file-preview-item">
                                            {% if form.instance.file.url|lower|slice:'-4:' in '.jpg,.jpeg,.png,.gif,.bmp,.webp' %}
                                                <img src="{{ form.instance.file.url }}" alt="Day {{ forloop.counter }} image">
                                            {% elif form.instance.file.url|lower|slice:'-4:' in '.mp4,.mov,.avi,.webm,.mkv' %}
                                                <video controls style="width:100%;height:100%;">
                                                    <source src="{{ form.instance.file.url }}">
                                                </video>
                                            {% elif form.instance.file.url|lower|slice:'-4:' in '.mp3,.wav,.ogg,.m4a' %}
                                                <div class="audio-preview">
                                                    <i class="fas fa-music" style="font-size: 24px; color: #1da1f2;"></i>
                                                    <audio controls style="width: 100%; margin-top: 8px;">
                                                        <source src="{{ form.instance.file.url }}">
                                                    </audio>
                                                </div>
                                            {% else %}
                                                <div class="audio-preview">
                                                    <i class="fas fa-file" style="font-size: 24px; color: #657786;"></i>
                                                    <div style="font-size: 12px; margin-top: 8px;">Day {{ forloop.counter }} file</div>
                                                </div>
                                            {% endif %}
                                            <button type="button" class="remove-file-btn" onclick="removeExistingFile({{ form_index }})">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <div class="file-name">
                                            {% if form.instance.file.name|length > 20 %}
                                                {{ form.instance.file.name|slice:":17" }}...
                                            {% else %}
                                                {{ form.instance.file.name }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                    {% else %}
                        <!-- NEW ACTIVITY - Check if locked -->
                        {% if is_next_day_locked %}
                            <!-- LOCKED NEW ACTIVITY -->
                            <div class="form-section locked" id="activity-form-{{ form_index }}">
                                <div class="form-header">
                                    <h3 class="form-title">
                                        <span class="activity-number">{{ forloop.counter }}</span>
                                        <span class="day-label">
                                            Day {{ next_available_day }}
                                            <span class="locked-badge-small">
                                                <i class="fas fa-lock"></i> Locked
                                            </span>
                                        </span>
                                        <span class="locked-form-type">
                                            <i class="fas fa-hourglass-half"></i> Available in {{ days_until_unlock }}d
                                        </span>
                                    </h3>
                                </div>
                                
                                <!-- Disabled form fields -->
                                <div style="margin-bottom: 20px;">
                                    <label class="form-label" style="color: #9ca3af;">
                                        <i class="fas fa-lock"></i> Day {{ next_available_day }} is locked
                                    </label>
                                    <textarea disabled class="form-textarea locked-input" 
                                              placeholder="This day will be available in {{ days_until_unlock }} day{% if days_until_unlock > 1 %}s{% endif %}..."></textarea>
                                    <span class="form-helper locked-helper">
                        <i class="fas fa-info-circle"></i> 
                        {% with unlock_date=campaign.start_date|date:"U"|add:next_available_day|add:"-1"|add:"86400" %}
                            {% with unlock_timestamp=unlock_date|floatformat:0 %}
                                Unlocks on {{ unlock_timestamp|date:"M d, Y" }} ({{ days_until_unlock }} day{% if days_until_unlock > 1 %}s{% endif %} from now)
                            {% endwith %}
                        {% endwith %}
                    </span>
                                </div>
                                
                                <!-- Disabled file upload -->
                                <div>
                                    <label class="form-label" style="color: #9ca3af;">Add media (locked)</label>
                                    <div class="file-upload-area" style="background: #f3f4f6; border-color: #d1d5db; cursor: not-allowed;">
                                        <i class="fas fa-cloud-upload-alt file-upload-icon" style="color: #9ca3af;"></i>
                                        <div class="file-upload-text" style="color: #9ca3af;">Upload unavailable while locked</div>
                                    </div>
                                </div>
                                
                                <!-- Hidden fields to prevent submission -->
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                            </div>
                        {% else %}
                            <!-- UNLOCKED NEW ACTIVITY -->
                            <div class="form-section new-activity" 
                                 id="activity-form-{{ form_index }}" 
                                 data-form-index="{{ form_index }}">
                                
                                <div class="form-header">
                                    <h3 class="form-title">
                                        <span class="activity-number">{{ forloop.counter }}</span>
                                        <span class="day-label">
                                            Day {{ next_available_day }}
                                            {% if campaign.duration %}
                                                <span class="target-info">
                                                    of {{ campaign.duration }}
                                                </span>
                                            {% endif %}
                                        </span>
                                        <span class="form-type-badge badge-new">
                                            <i class="fas fa-plus"></i> Available Now
                                        </span>
                                    </h3>
                                </div>
                                
                                <!-- HIDDEN FIELDS -->
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                
                                <!-- CONTENT FIELD -->
                                <div style="margin-bottom: 20px;">
                                    <label class="form-label">
                                        What would you like to share for Day {{ next_available_day }}? (optional)
                                    </label>
                                    {{ form.content }}
                                    <span class="form-helper">
                                        Share your progress, thoughts, or updates
                                    </span>
                                    
                                    <!-- EMOJI SECTION -->
                                    <div class="emoji-section">
                                        <div class="emoji-section-label">
                                            <i class="fas fa-smile"></i>
                                            Add feeling for Day {{ next_available_day }} (optional)
                                        </div>
                                        
                                        <div class="emoji-container" id="emojiContainer-{{ form_index }}">
                                            {% for emoji in initial_emojis %}
                                                <button type="button" 
                                                        class="emoji-button" 
                                                        onclick="addEmojiToField('{{ emoji }}', {{ form_index }})">
                                                    {{ emoji }}
                                                </button>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- MEDIA FIELD -->
                                <div>
                                    <label class="form-label">
                                        Add media for Day {{ next_available_day }} (optional):
                                    </label>
                                    
                                    <div class="file-upload-area" id="drop-area-{{ form_index }}">
                                        <i class="fas fa-cloud-upload-alt file-upload-icon"></i>
                                        <div class="file-upload-text">
                                            Upload image, video, or audio
                                        </div>
                                        <span class="form-helper">Click or drag & drop (max 10MB)</span>
                                        <input type="file" 
                                               class="file-input-hidden" 
                                               id="file-input-{{ form_index }}"
                                               accept="image/*,video/*,audio/*"
                                               onchange="handleFileSelect({{ form_index }})">
                                    </div>
                                    
                                    <!-- HIDDEN DJANGO FILE FIELD -->
                                    {{ form.file }}
                                    
                                    <!-- FILE PREVIEW AREA -->
                                    <div id="file-preview-{{ form_index }}" class="file-preview-container"></div>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                    
                    {% endwith %}
                    
                    <!-- SEPARATOR (except last form) -->
                    {% if not forloop.last %}
                    <hr style="border: none; border-top: 2px dashed #e1e8ed; margin: 32px 0;">
                    {% endif %}
                {% endfor %}
                
                <!-- SUBMIT BUTTON -->
                <button type="submit" class="submit-button" id="submitBtn" 
                        {% if is_next_day_locked and not existing_activities_count > 0 %}disabled{% endif %}>
                    <i class="fas fa-save"></i>
                    {% if is_next_day_locked %}
                        {% if existing_activities_count > 0 %}
                            Save Changes to Previous Days
                        {% else %}
                            Waiting for Day 1 to Unlock...
                        {% endif %}
                    {% else %}
                        {% if existing_activities_count > 0 %}
                            Save Changes & Post Day {{ next_available_day }}
                        {% else %}
                            Begin Day 1 of Your Journey
                        {% endif %}
                    {% endif %}
                </button>
                
                <!-- JOURNEY PROGRESS NOTE -->
                <div style="text-align: center; margin-top: 24px; color: #657786; font-size: 14px; line-height: 1.5;">
                    <i class="fas fa-sync-alt" style="margin-right: 8px;"></i>
                    <strong>Real-time journey:</strong> 
                    {% if existing_activities_count == 0 %}
                        Start today, Day 2 unlocks tomorrow
                    {% elif is_next_day_locked %}
                        Day {{ next_available_day }} unlocks in {{ days_until_unlock }} days
                    {% else %}
                        Day {{ next_available_day }} is ready for your update
                    {% endif %}
                </div>
            </form>
            {% endif %}
        {% endif %}
    </div>
</div>

<!-- BACK BUTTON -->
<a href="{% url 'view_campaign' campaign_id=campaign.pk %}" class="back-button">
    <i class="fas fa-arrow-left"></i>
    Back to "{{ campaign.title }}"
</a>

<script>
    // ===== EMOJI HANDLING =====
    function addEmojiToField(emoji, formIndex) {
        const form = document.getElementById(`activity-form-${formIndex}`);
        if (!form) return;
        
        const textarea = form.querySelector('textarea[name$="-content"]');
        if (!textarea) return;
        
        const cursorPos = textarea.selectionStart;
        const textBefore = textarea.value.substring(0, cursorPos);
        const textAfter = textarea.value.substring(cursorPos);
        
        textarea.value = textBefore + emoji + textAfter;
        textarea.focus();
        textarea.selectionStart = cursorPos + emoji.length;
        textarea.selectionEnd = cursorPos + emoji.length;
        
        // Trigger resize
        textarea.dispatchEvent(new Event('input'));
    }
    
    // ===== FILE UPLOAD HANDLING =====
    function handleFileSelect(formIndex) {
        const fileInput = document.getElementById(`file-input-${formIndex}`);
        const djangoFileInput = document.querySelector(`#activity-form-${formIndex} input[name$="-file"]`);
        const previewArea = document.getElementById(`file-preview-${formIndex}`);
        
        if (!fileInput || !fileInput.files.length || !djangoFileInput) return;
        
        // Clear previous preview
        previewArea.innerHTML = '';
        
        // Create DataTransfer to handle files
        const dt = new DataTransfer();
        const files = Array.from(fileInput.files);
        
        // Only take the first file
        const file = files[0];
        dt.items.add(file);
        
        // Update the Django file input
        djangoFileInput.files = dt.files;
        
        // Create preview
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewItem = document.createElement('div');
            
            if (file.type.startsWith('image/')) {
                previewItem.innerHTML = `
                    <div class="file-preview-item">
                        <img src="${e.target.result}" alt="${file.name}">
                        <button type="button" class="remove-file-btn" onclick="removeFile(${formIndex})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="file-name">${file.name.length > 20 ? file.name.substring(0, 17) + '...' : file.name}</div>
                `;
            } else if (file.type.startsWith('video/')) {
                previewItem.innerHTML = `
                    <div class="file-preview-item">
                        <video controls style="width:100%;height:100%;">
                            <source src="${e.target.result}" type="${file.type}">
                        </video>
                        <button type="button" class="remove-file-btn" onclick="removeFile(${formIndex})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="file-name">${file.name.length > 20 ? file.name.substring(0, 17) + '...' : file.name}</div>
                `;
            } else if (file.type.startsWith('audio/')) {
                previewItem.innerHTML = `
                    <div class="file-preview-item">
                        <div class="audio-preview">
                            <i class="fas fa-music" style="font-size: 24px; color: #1da1f2;"></i>
                            <audio controls style="width: 100%; margin-top: 8px;">
                                <source src="${e.target.result}" type="${file.type}">
                            </audio>
                            <button type="button" class="remove-file-btn" onclick="removeFile(${formIndex})" style="position: absolute; top: 5px; right: 5px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="file-name">${file.name.length > 20 ? file.name.substring(0, 17) + '...' : file.name}</div>
                `;
            } else {
                previewItem.innerHTML = `
                    <div class="file-preview-item">
                        <div class="audio-preview">
                            <i class="fas fa-file" style="font-size: 24px; color: #657786;"></i>
                            <div style="font-size: 12px; margin-top: 8px;">${file.name.length > 20 ? file.name.substring(0, 17) + '...' : file.name}</div>
                            <button type="button" class="remove-file-btn" onclick="removeFile(${formIndex})" style="position: absolute; top: 5px; right: 5px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="file-name">${file.name.length > 20 ? file.name.substring(0, 17) + '...' : file.name}</div>
                `;
            }
            
            previewArea.appendChild(previewItem);
            previewArea.style.display = 'grid';
        };
        
        reader.readAsDataURL(file);
    }
    
    function removeFile(formIndex) {
        const fileInput = document.getElementById(`file-input-${formIndex}`);
        const djangoFileInput = document.querySelector(`#activity-form-${formIndex} input[name$="-file"]`);
        const previewArea = document.getElementById(`file-preview-${formIndex}`);
        
        if (fileInput) fileInput.value = '';
        if (djangoFileInput) djangoFileInput.value = '';
        if (previewArea) {
            previewArea.innerHTML = '';
            previewArea.style.display = 'none';
        }
    }
    
    function removeExistingFile(formIndex) {
        const existingDiv = document.getElementById(`existing-file-${formIndex}`);
        const clearCheckbox = document.querySelector(`#activity-form-${formIndex} input[name$="-file-clear"]`);
        
        if (existingDiv) existingDiv.style.display = 'none';
        if (clearCheckbox) clearCheckbox.checked = true;
    }
    
    // ===== DRAG & DROP =====
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize drag and drop for unlocked forms only
        document.querySelectorAll('.form-section:not(.locked)').forEach(formElement => {
            const formIndex = formElement.dataset.formIndex;
            const dropArea = document.getElementById(`drop-area-${formIndex}`);
            
            if (dropArea) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight() {
                    dropArea.style.borderColor = '#1da1f2';
                    dropArea.style.background = '#e8f5fe';
                }
                
                function unhighlight() {
                    dropArea.style.borderColor = '#e1e8ed';
                    dropArea.style.background = '#fafbfd';
                }
                
                dropArea.addEventListener('drop', function(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    const fileInput = document.getElementById(`file-input-${formIndex}`);
                    
                    if (fileInput && files.length > 0) {
                        fileInput.files = files;
                        handleFileSelect(formIndex);
                    }
                });
            }
        });
        
        // Auto-resize textareas (only for unlocked forms)
        document.querySelectorAll('.form-section:not(.locked) textarea').forEach(textarea => {
            if (textarea.name.includes('-content')) {
                textarea.classList.add('activity-content');
            }
            
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });
            
            // Initial resize
            setTimeout(() => {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
            }, 100);
        });
        
        // Scroll to new activity forms if unlocked and not at max
        {% if not is_next_day_locked and not campaign.duration or existing_activities_count < campaign.duration %}
        document.querySelectorAll('.new-activity').forEach(form => {
            form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
        {% endif %}
        
        // Show celebration if user is ahead
        {% if schedule_status == 'ahead' and schedule_diff > 0 %}
        const celebrationDiv = document.createElement('div');
        celebrationDiv.className = 'celebration-note';
        celebrationDiv.innerHTML = `
            <i class="fas fa-rocket"></i>
            <div>
                <strong>You're {{ schedule_diff }} day{% if schedule_diff > 1 %}s{% endif %} ahead of schedule!</strong><br>
                Great job staying consistent with your journey.
            </div>
        `;
        document.querySelector('.activity-body').insertBefore(celebrationDiv, document.querySelector('.flexibility-note'));
        {% endif %}
        
        // Show warning if user is behind
        {% if schedule_status == 'behind' and schedule_diff > 0 %}
        const warningDiv = document.createElement('div');
        warningDiv.className = 'max-limit-warning';
        warningDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>You're {{ schedule_diff }} day{% if schedule_diff > 1 %}s{% endif %} behind schedule</strong><br>
                Don't worry - you can still catch up! Post your updates when each day unlocks.
            </div>
        `;
        document.querySelector('.activity-body').insertBefore(warningDiv, document.querySelector('.flexibility-note'));
        {% endif %}
    });
    
    // ===== FORM VALIDATION =====
    document.getElementById('activityForm')?.addEventListener('submit', function(e) {
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        
        // Check if trying to submit locked day
        {% if is_next_day_locked %}
        const hasLockedForms = document.querySelectorAll('.form-section.locked').length > 0;
        if (hasLockedForms) {
            e.preventDefault();
            alert('Day {{ next_available_day }} is still locked. Please wait until it unlocks.');
            return false;
        }
        {% endif %}
        
        // Validate file sizes
        let allFilesValid = true;
        document.querySelectorAll('.form-section:not(.locked) input[type="file"]').forEach(input => {
            Array.from(input.files).forEach(file => {
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.size > maxSize) {
                    allFilesValid = false;
                    alert(`File "${file.name}" is too large (${(file.size/1024/1024).toFixed(1)}MB). Maximum size is 10MB.`);
                }
            });
        });
        
        if (!allFilesValid) {
            e.preventDefault();
            return false;
        }
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving your journey...';
        submitBtn.disabled = true;
        
        // Re-enable after 10 seconds if submission fails
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 10000);
        
        return true;
    });
    
    // Keyboard shortcut (Ctrl+Enter)
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            const form = document.getElementById('activityForm');
            if (form) {
                e.preventDefault();
                form.submit();
            }
        }
    });
</script>

{% endblock %}