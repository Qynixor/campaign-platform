{% extends 'main/face.html' %}

{% block content %}
<style type="text/css">
/* General Styling */
.top-participants {
    font-size: 1.1rem;
    color: #555;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 0;
    max-width: 550px;
    margin: 0 auto;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

@media (max-width: 768px) {
    .top-participants {
        font-size: 1rem;
        max-width: 95%;
    }
}

/* Title Styling */
.cc-header {
    background-color: #ffffff;
    border-bottom: 2px solid #007bff;
    padding: 12px 18px;
    text-align: center;
}

.cc-header .activity-title {
    font-size: 1.2rem;
    color: #666;
    margin: 6px 0;
    font-weight: bold;
}

.cc-header .activity-title a {
    color: #3498db;
    text-decoration: none;
    font-size: 1.1rem;
}

.cc-header .activity-title a:hover {
    text-decoration: underline;
}

.cc-header .activity-count {
    color: gray;
    padding-left: 20px;
    font-size: 1rem;
    margin: 4px 0;
}

/* Mobile styles */
@media (max-width: 768px) {
    .cc-header {
        padding: 10px 15px;
    }

    .cc-header .activity-title {
        font-size: 1.1rem;
    }

    .cc-header .activity-count {
        font-size: 0.95rem;
        padding-left: 10px;
    }
}

/* Smaller mobile devices */
@media (max-width: 480px) {
    .cc-header {
        padding: 8px 12px;
    }

    .cc-header .activity-title {
        font-size: 1rem;
    }

    .cc-header .activity-count {
        font-size: 0.9rem;
        padding-left: 8px;
    }
}

/* Table Styling */
.participants-table {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    font-size: 1rem;
    width: 100%;
}

.participants-table th {
    background-color: #0044cc;
    color: white;
    text-align: center;
    font-size: 1rem;
    padding: 10px 8px;
}

.participants-table td {
    text-align: center;
    vertical-align: middle;
    color: #333;
    padding: 10px 8px;
}

/* Participant Cell - Desktop layout (side by side) */
.participant-cell {
    min-width: 180px;
}

.participant-link {
    text-decoration: none;
    color: #0044cc;
    font-weight: bold;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    justify-content: flex-start;
}

.participant-link:hover {
    text-decoration: underline;
    color: #002b80;
}

/* Participant Image */
.participant-img {
    margin-right: 10px;
    border: 1px solid #ddd;
    padding: 2px;
    width: 40px;
    height: 40px;
    object-fit: cover;
    flex-shrink: 0;
}

.participant-name {
    word-break: break-word;
    overflow-wrap: break-word;
}

/* MOBILE FIX: Stack profile pic above username */
@media (max-width: 768px) {
    .participant-cell {
        min-width: 150px;
    }
    
    .participant-link {
        flex-direction: column; /* Stack vertically */
        align-items: center;
        text-align: center;
        padding: 8px 4px;
    }
    
    .participant-img {
        margin-right: 0;
        margin-bottom: 6px; /* Space between image and name */
        width: 36px;
        height: 36px;
    }
    
    .participant-name {
        display: block;
        width: 100%;
        line-height: 1.2;
        font-size: 0.9rem;
    }
    
    /* Adjust table cell padding for mobile */
    .participants-table td {
        padding: 8px 4px;
    }
    
    .participants-table th {
        padding: 10px 4px;
    }
}

/* Very small screens */
@media (max-width: 480px) {
    .participant-cell {
        min-width: 130px;
    }
    
    .participant-img {
        width: 32px;
        height: 32px;
        margin-bottom: 4px;
    }
    
    .participant-link {
        font-size: 0.85rem;
        padding: 6px 2px;
    }
    
    .participant-name {
        font-size: 0.85rem;
    }
}

/* Dark Mode Styles - UNCHANGED */
body.dark-mode {
    background-color: #121212;
    color: #ffffff;
}

body.dark-mode header,
body.dark-mode footer,
body.dark-mode section,
body.dark-mode .left-aside,
body.dark-mode .right-aside,
body.dark-mode .upper-post,
body.dark-mode .campaign-content,
body.dark-mode .react div {
    background-color: #1e1e1e;
    color: #ffffff;
}

body.dark-mode .campaign-category {
    background-color: #333333;
    color: #ffffff;
}

body.dark-mode .objectives-activities {
    background-color: #262626;
    border-left: 4px solid #3498db;
    color: #ffffff;
}

body.dark-mode .search-container input[type="text"] {
    background-color: #333333;
    color: #ffffff;
    border: 1px solid #444444;
}

body.dark-mode .search-container .btn-reset {
    color: #b0b0b0;
}

body.dark-mode button:not(.btn-search, .btn-reset) {
    background-color: #262626;
    color: #ffffff;
}

body.dark-mode .explore-link i {
    color: #ffffff;
}

body.dark-mode .love-count,
body.dark-mode #view-count,
body.dark-mode .comment-count {
    color: #ffffff;
}

body.dark-mode .affiliate-link {
    display: inline-block;
    margin-bottom: 20px;
    padding: 10px 15px;
    background-color: #3498db;
    color: #ffffff;
    border-radius: 5px;
    text-decoration: none;
    font-size: 14px;
    transition: background-color 0.3s ease;
}

body.dark-mode .affiliate-link:hover {
    background-color: #2980b9;
}

body.dark-mode .affiliate-link i {
    margin-right: 8px;
}
</style>

<style type="text/css">
/* Sub header */
.sub {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
    padding: 12px;
    border-radius: 10px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    max-width: 550px;
    margin-left: auto;
    margin-right: auto;
}

.sub:hover {
    transform: translateY(-2px);
}

.sub i {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    font-size: 15px;
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    color: #4b5563;
    border-radius: 50%;
    flex-shrink: 0;
    border: 1px solid #f9fafb;
}

.sub h2 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
}

.sub p {
    margin: 5px 0 0;
    font-size: 13px;
    color: #6b7280;
    line-height: 1.45;
}

/* Dark mode for sub elements */
body.dark-mode .sub {
    background: #1e1e1e;
    border: 1px solid #333;
}

body.dark-mode .sub i {
    background: linear-gradient(135deg, #2d2d2d 0%, #252525 100%);
    color: #b0b0b0;
    border: 1px solid #333;
}

body.dark-mode .sub h2 {
    color: #f0f0f0;
}

body.dark-mode .sub p {
    color: #a0a0a0;
}
</style>

<div class="sub">
   <i class="fas fa-trophy"></i>
   <div>
       <h2>Top Participants</h2>
       <p>Discover the most active participants making a big impact in this cause.</p>
   </div>
</div>

<div class="container mt-3 top-participants">
    <div class="cc-header">
        <h3 class="activity-title">
            <hr>
            <span>
                Top Participants for "
                <a href="{% url 'view_campaign' campaign_id=campaign.pk %}" class="campaign-link">
                    {{ campaign.title }}
                </a>
                "
            </span>
        </h3>
    </div>
    <table class="table table-bordered mt-2 participants-table">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Participant</th>
                <th>Engagement Score</th>
            </tr>
        </thead>
        <tbody>
            {% for participant in top_participants %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td class="participant-cell">
                    <a href="{% url 'profile_view' participant.user.username %}" class="participant-link">
                        <img src="{{ participant.user.profile.image.url }}" 
                             alt="{{ participant.user.username }}" 
                             class="participant-img rounded-circle">
                        <span class="participant-name">{{ participant.user.username }}</span>
                    </a>
                </td>
                <td>{{ participant.score }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script type="text/javascript">
    
        // Function to handle file upload and playback
        function uploadAudio() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = 'audio/*, video/*'; // Limit file selection to audio files

            // Listen for file selection
            input.onchange = function(e) {
                var file = e.target.files[0];
                var audio = document.getElementById('bgAudio');

                // Pause the current audio playback
                audio.pause();

                // Store the selected audio file and its playback position in local storage
                localStorage.setItem('bgAudioFile', URL.createObjectURL(file));
                localStorage.setItem('bgAudioPosition', audio.currentTime);

                // Set the audio source to the selected file
                audio.src = localStorage.getItem('bgAudioFile');

                // Resume audio playback
                audio.play();
            };

            // Trigger the file input
            input.click();
        }

        // Function to set background audio on page load
        window.onload = function() {
            var audio = document.getElementById('bgAudio');
            var bgAudioFile = localStorage.getItem('bgAudioFile');
            var audioPosition = parseFloat(localStorage.getItem('bgAudioPosition'));

            // Check if there's a stored audio file
            if (bgAudioFile) {
                // Set the audio source to the stored file
                audio.src = bgAudioFile;

                // Set the playback position if available
                if (!isNaN(audioPosition)) {
                    audio.currentTime = audioPosition;
                }

                // Autoplay the audio
                audio.play();
            }
        };


function toggleCommentForm() {
    var popup = document.getElementById("commentFormPopup");
    popup.style.display = "block";
}

function closeCommentForm() {
    var popup = document.getElementById("commentFormPopup");
    popup.style.display = "none";
}

document.addEventListener('DOMContentLoaded', function() {
    var campaignElement = document.querySelector('.campaign-details');
    var campaignId = {{ campaign.id }};
    var startTime;

    function recordCampaignView() {
        var endTime = Math.floor(Date.now() / 1000); // Get current time in seconds
        var timeSpent = endTime - startTime;
        
        fetch(`/record_campaign_view/${campaignId}/`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ time_spent: timeSpent })
        })
        .then(response => {
            if (response.ok) {
                console.log('View recorded successfully');
            } else {
                console.error('Failed to record view');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function handleVisibilityChange() {
        if (document.visibilityState === 'visible') {
            startTime = Math.floor(Date.now() / 1000); // Get current time in seconds
        } else {
            recordCampaignView();
        }
    }

    function isInViewport(element) {
        var rect = element.getBoundingClientRect();
        return (
            rect.top >= 0 &&
            rect.left >= 0 &&
            rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
            rect.right <= (window.innerWidth || document.documentElement.clientWidth)
        );
    }

    function handleScroll() {
        if (isInViewport(campaignElement)) {
            startTime = Math.floor(Date.now() / 1000); // Get current time in seconds
        } else {
            recordCampaignView();
        }
    }

    document.addEventListener('visibilitychange', handleVisibilityChange);
    document.addEventListener('scroll', handleScroll);
});

document.addEventListener('DOMContentLoaded', function() {
    var mediaQuery = window.matchMedia('(max-width: 768px)');
    var leftAside = document.querySelector('.left-aside');
    var rightAside = document.querySelector('.right-aside');

    function handleMediaQueryChange(e) {
        if (e.matches) {
            leftAside.style.display = 'none';
            rightAside.style.display = 'none';
        } else {
            leftAside.style.display = 'block';
            rightAside.style.display = 'block';
        }
    }

    mediaQuery.addListener(handleMediaQueryChange);
    handleMediaQueryChange(mediaQuery);
});


</script>

<script type="text/javascript">
function switchColor() {
    const body = document.body;
    const isDarkMode = body.classList.toggle('dark-mode'); // Toggle dark mode class
    var reactDivs = document.querySelectorAll('.react');

    // Update background and text colors for all elements
    const elementsToUpdate = document.querySelectorAll(
        'header, footer, section, .left-aside, .right-aside, .upper-post, .campaign-content, .react, .search-container input, .search-container .btn-reset'
    );

    elementsToUpdate.forEach(element => {
        element.classList.toggle('dark-mode', isDarkMode);
    });

    // Update text colors for specific elements
    const textElements = document.querySelectorAll(
        'h1, h2, h4, p, li, .campaign-nav, .campaign-nav a, .btn, .reaction, .action-item, .action-item a, .carousel, .ad, .slide, .ad a, .explore-link, .love-count, #view-count, .comment-count'
    );

    textElements.forEach(element => {
        element.style.color = isDarkMode ? '#ffffff' : '#000000';
    });

    // Update buttons
    const buttons = document.querySelectorAll('button:not(.btn-search, .btn-reset)');
    buttons.forEach(button => {
        button.style.backgroundColor = isDarkMode ? '#262626' : '';
        button.style.color = isDarkMode ? '#ffffff' : '#000000';
    });

    // Update `.react` divs
    if (reactDivs.length > 0) {
        reactDivs.forEach(function(reactDiv) {
            reactDiv.style.backgroundColor = isDarkMode ? "#262626" : "";
            reactDiv.style.color = isDarkMode ? "white" : "black";

            if (isDarkMode) {
                reactDiv.classList.add('react-hover');
            } else {
                reactDiv.classList.remove('react-hover');
                reactDiv.style.backgroundColor = "";
            }
        });
    }

    // Update input field and reset button
    const inputField = document.querySelector('.search-container input[type="text"]');
    const inputResetButton = document.querySelector('.search-container .btn-reset');

    if (inputField) {
        inputField.style.backgroundColor = isDarkMode ? '#333333' : '#ffffff';
        inputField.style.color = isDarkMode ? '#ffffff' : '#000000';
    }

    if (inputResetButton) {
        inputResetButton.style.color = '#b0b0b0';
    }
}

</script>


{% endblock %}
