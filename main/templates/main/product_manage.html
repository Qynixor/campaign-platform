{% extends 'main/face.html' %}
{% load static %}

{% block content %}

<style type="text/css">
    /* ===== BASE RESET ===== */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f8f9fa;
        color: #0f1419;
        line-height: 1.5;
    }

    /* ===== MAIN CONTAINER ===== */
    .store-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    /* ===== SILVER HEADER (Campaign Products) ===== */
    .sub {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: visible;
    }

    .sub-content {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .sub-icon {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, #dee2e6 0%, #adb5bd 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #495057;
        font-size: 20px;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .sub h2 {
        font-size: 24px;
        font-weight: 700;
        color: #212529;
        margin-bottom: 4px;
    }

    .sub p {
        color: #6c757d;
        font-size: 14px;
        margin: 0;
    }

    /* ===== FILTER & SORT BAR ===== */
    .filter-sort-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .filter-box, .sort-box {
        background: white;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e9ecef;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        font-size: 14px;
        font-weight: 600;
        color: #495057;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .section-title i {
        color: #1d9bf0;
    }

    .filter-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .filter-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .filter-option:hover {
        background-color: #f8f9fa;
    }

    .filter-option input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #1d9bf0;
    }

    .filter-option label {
        font-size: 14px;
        color: #495057;
        cursor: pointer;
        font-weight: 500;
    }

    .sort-select-wrapper {
        position: relative;
    }

    .sort-select {
        width: 100%;
        padding: 10px 40px 10px 12px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 14px;
        color: #212529;
        background: white;
        cursor: pointer;
        appearance: none;
        transition: border-color 0.2s;
    }

    .sort-select:focus {
        outline: none;
        border-color: #1d9bf0;
        box-shadow: 0 0 0 2px rgba(29, 155, 240, 0.1);
    }

    .sort-select-wrapper::after {
        content: '\f078';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        pointer-events: none;
        font-size: 12px;
    }

    /* ===== SELLER PROFILE ===== */
    .seller-profile-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        border: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .seller-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
    }

    .seller-info {
        flex: 1;
    }

    .seller-name {
        font-size: 16px;
        font-weight: 600;
        color: #212529;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .seller-role {
        font-size: 13px;
        color: #6c757d;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .view-seller-btn {
        background: #1d9bf0;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        text-decoration: none;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .view-seller-btn:hover {
        background: #1a8cd8;
        transform: translateY(-1px);
    }

    /* ===== PRODUCTS HEADER ===== */
    .products-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding: 0 4px;
    }

    .product-count {
        font-size: 14px;
        color: #6c757d;
        font-weight: 500;
    }

    .view-toggle {
        display: flex;
        gap: 8px;
    }

    .view-btn {
        width: 36px;
        height: 36px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: white;
        color: #6c757d;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .view-btn.active {
        background: #1d9bf0;
        color: white;
        border-color: #1d9bf0;
    }

    .view-btn:hover:not(.active) {
        border-color: #1d9bf0;
        color: #1d9bf0;
    }

    /* ===== PRODUCT GRID ===== */
    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .product-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .product-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
        border-color: #1d9bf0;
    }

    /* Product Image */
    .product-image {
        position: relative;
        height: 180px;
        overflow: hidden;
        background: #f8f9fa;
    }

    .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.6s ease;
    }

    .product-card:hover .product-image img {
        transform: scale(1.05);
    }

    .placeholder-image {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #adb5bd;
        font-size: 14px;
    }

    /* Product Badges */
    .product-badges {
        position: absolute;
        top: 12px;
        left: 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        white-space: nowrap;
    }

    .badge.inactive {
        background: #6c757d;
        color: white;
    }

    .badge.out-of-stock {
        background: #dc3545;
        color: white;
    }

    .badge.low-stock {
        background: #fd7e14;
        color: white;
    }

    .badge.in-stock {
        background: #198754;
        color: white;
    }

    /* Quick View Button */
    .quick-view-btn {
        position: absolute;
        bottom: 12px;
        right: 12px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #dee2e6;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        color: #495057;
        cursor: pointer;
        opacity: 0;
        transform: translateY(8px);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
        backdrop-filter: blur(8px);
    }

    .product-image:hover .quick-view-btn {
        opacity: 1;
        transform: translateY(0);
    }

    .quick-view-btn:hover {
        background: white;
        border-color: #1d9bf0;
        color: #1d9bf0;
    }

    /* Product Info */
    .product-info {
        padding: 16px;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .product-title {
        font-size: 15px;
        font-weight: 600;
        color: #212529;
        margin-bottom: 8px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .product-description {
        font-size: 13px;
        color: #6c757d;
        line-height: 1.5;
        margin-bottom: 12px;
        flex: 1;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Stock Status */
    .stock-display {
        margin-bottom: 12px;
    }

    .stock-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
    }

    .in-stock-status {
        background: rgba(25, 135, 84, 0.1);
        color: #198754;
        border: 1px solid rgba(25, 135, 84, 0.2);
    }

    .low-stock-status {
        background: rgba(253, 126, 20, 0.1);
        color: #fd7e14;
        border: 1px solid rgba(253, 126, 20, 0.2);
    }

    .out-of-stock-status {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.2);
    }

    /* Product Meta */
    .product-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .product-price {
        font-size: 18px;
        font-weight: 700;
        color: #1d9bf0;
    }

    /* Middleman Note */
    .middleman-note {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 6px;
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 16px;
        border: 1px solid #e9ecef;
    }

    .middleman-note i {
        color: #1d9bf0;
        font-size: 11px;
    }

    /* Checkout Button - Twitter Blue */
    .checkout-btn {
        width: 100%;
        padding: 12px;
        background: #1d9bf0;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
        text-decoration: none;
        margin-top: auto;
    }

    .checkout-btn:hover:not(:disabled) {
        background: #1a8cd8;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(29, 155, 240, 0.2);
    }

    .checkout-btn:disabled {
        background: #adb5bd;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none;
    }

    /* No Products */
    .no-products {
        grid-column: 1 / -1;
        text-align: center;
        padding: 48px 24px;
        background: white;
        border-radius: 12px;
        border: 1px dashed #dee2e6;
    }

    .no-products i {
        font-size: 48px;
        color: #dee2e6;
        margin-bottom: 16px;
    }

    .no-products h3 {
        font-size: 18px;
        color: #495057;
        margin-bottom: 8px;
    }

    .no-products p {
        color: #6c757d;
        font-size: 14px;
    }

    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin: 32px 0;
    }

    .page-btn {
        min-width: 36px;
        height: 36px;
        padding: 0 12px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: white;
        color: #495057;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .page-btn:hover:not(:disabled) {
        border-color: #1d9bf0;
        color: #1d9bf0;
        transform: translateY(-1px);
    }

    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .page-numbers {
        padding: 8px 16px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        color: #495057;
    }

    /* ===== MODAL ===== */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }

    .modal-overlay.active {
        display: flex;
        animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-container {
        background: white;
        border-radius: 16px;
        width: 100%;
        max-width: 900px;
        max-height: 90vh;
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h3 {
        font-size: 18px;
        font-weight: 600;
        color: #212529;
        margin: 0;
    }

    .modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: #f8f9fa;
        border-radius: 8px;
        color: #6c757d;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .modal-close:hover {
        background: #e9ecef;
        color: #212529;
    }

    .modal-body {
        padding: 24px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        max-height: calc(90vh - 80px);
        overflow-y: auto;
    }

    .modal-image {
        border-radius: 12px;
        overflow: hidden;
        background: #f8f9fa;
    }

    .modal-image img {
        width: 100%;
        height: auto;
        max-height: 300px;
        object-fit: contain;
    }

    .modal-details {
        display: flex;
        flex-direction: column;
    }

    .modal-price {
        font-size: 28px;
        font-weight: 700;
        color: #1d9bf0;
        margin-bottom: 16px;
    }

    .modal-description {
        font-size: 14px;
        color: #495057;
        line-height: 1.6;
        margin-bottom: 24px;
    }

    .modal-stock-info {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 20px;
        width: fit-content;
    }

    .modal-middleman-note {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background: rgba(29, 155, 240, 0.1);
        border-radius: 8px;
        font-size: 13px;
        color: #1d9bf0;
        margin-bottom: 24px;
        border: 1px solid rgba(29, 155, 240, 0.2);
    }

    .modal-actions {
        margin-top: auto;
    }

    /* ===== ADMIN PANEL ===== */
    .admin-panel {
        background: white;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        margin-top: 32px;
        overflow: hidden;
    }

    .panel-toggle {
        padding: 16px 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .panel-toggle:hover {
        background: #e9ecef;
    }

    .panel-toggle i:first-child {
        color: #1d9bf0;
        margin-right: 10px;
    }

    .toggle-icon {
        transition: transform 0.3s ease;
    }

    .toggle-icon.rotated {
        transform: rotate(180deg);
    }

    .form-section {
        padding: 24px;
        display: none;
    }

    .form-section.active {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .form-heading {
        font-size: 18px;
        font-weight: 600;
        color: #212529;
        margin-bottom: 20px;
    }

    .product-form {
        display: grid;
        gap: 20px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .form-grid p {
        margin: 0;
    }

    .save-btn {
        background: #1d9bf0;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        justify-self: start;
    }

    .save-btn:hover {
        background: #1a8cd8;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(29, 155, 240, 0.2);
    }

    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 768px) {
        .store-container {
            padding: 16px;
        }
        
        .sub-content {
            flex-direction: column;
            text-align: center;
            gap: 12px;
        }
        
        .filter-sort-container {
            grid-template-columns: 1fr;
        }
        
        .filter-options {
            grid-template-columns: 1fr;
        }
        
        .seller-profile-section {
            flex-direction: column;
            text-align: center;
            padding: 16px;
        }
        
        .seller-info {
            text-align: center;
        }
        
        .view-seller-btn {
            width: 100%;
            justify-content: center;
        }
        
        .products-header {
            flex-direction: column;
            gap: 12px;
            align-items: stretch;
        }
        
        .view-toggle {
            align-self: center;
        }
        
        .product-grid {
            grid-template-columns: 1fr;
        }
        
        .modal-body {
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        .modal-image {
            max-height: 200px;
        }
        
        .admin-panel {
            margin-top: 24px;
        }
    }

    @media (max-width: 480px) {
        .sub {
            padding: 20px;
        }
        
        .sub h2 {
            font-size: 20px;
        }
        
        .product-image {
            height: 160px;
        }
        
        .product-title {
            font-size: 14px;
        }
        
        .product-price {
            font-size: 16px;
        }
        
        .checkout-btn {
            padding: 10px;
            font-size: 13px;
        }
    }

    /* ===== DARK MODE ===== */
    body.dark-mode {
        background: #15202b;
        color: #e7e9ea;
    }
    
    body.dark-mode .sub {
        background: linear-gradient(135deg, #1c2733 0%, #22303c 100%);
        border-color: #38444d;
    }
    
    body.dark-mode .sub h2 {
        color: #e7e9ea;
    }
    
    body.dark-mode .sub p,
    body.dark-mode .section-title,
    body.dark-mode .filter-option label,
    body.dark-mode .sort-select,
    body.dark-mode .seller-role,
    body.dark-mode .product-count,
    body.dark-mode .product-description,
    body.dark-mode .middleman-note {
        color: #8b98a5;
    }
    
    body.dark-mode .filter-box,
    body.dark-mode .sort-box,
    body.dark-mode .seller-profile-section,
    body.dark-mode .product-card,
    body.dark-mode .no-products,
    body.dark-mode .modal-container,
    body.dark-mode .admin-panel,
    body.dark-mode .page-btn {
        background: #192734;
        border-color: #38444d;
    }
    
    body.dark-mode .seller-name,
    body.dark-mode .product-title,
    body.dark-mode .modal-header h3,
    body.dark-mode .form-heading {
        color: #e7e9ea;
    }
    
    body.dark-mode .modal-description {
        color: #8b98a5;
    }
    
    body.dark-mode .placeholder-image,
    body.dark-mode .no-products i {
        color: #38444d;
    }
    
    body.dark-mode .page-numbers {
        background: #22303c;
        color: #8b98a5;
    }
    
    body.dark-mode .panel-toggle {
        background: #22303c;
        border-color: #38444d;
    }
    
    body.dark-mode .panel-toggle:hover {
        background: #1c2733;
    }
</style>

<!-- SILVER HEADER (as requested) -->
<div class="sub">
   <div class="sub-content">
       <div class="sub-icon">
           <i class="fas fa-box-open"></i>
       </div>
       <div>
           <h2>Campaign Products</h2>
           <p>Browse products offered in this campaign and support by making a purchase.</p>
       </div>
   </div>
</div>

<!-- Seller Profile -->
<div class="seller-profile-section">
    <div class="seller-avatar-container">
        {% if campaign.user.image %}
            <img src="{{ campaign.user.image.url }}" alt="{{ campaign.user.user.username }}" class="seller-avatar">
        {% else %}
            <img src="{% static 'images/default-profile.png' %}" alt="{{ campaign.user.user.username }}" class="seller-avatar">
        {% endif %}
    </div>
    <div class="seller-info">
        <h3 class="seller-name">
            {{ campaign.user.user.get_full_name|default:campaign.user.user.username }}
            {% if campaign.user.profile_verified %}
                <i class="fas fa-check-circle" style="color: #1d9bf0;"></i>
            {% endif %}
        </h3>
        <p class="seller-role">
            <i class="fas fa-store"></i>
            Campaign Seller
        </p>
    </div>
    <a href="{% url 'profile_view' campaign.user.user.username %}" class="view-seller-btn">
        <i class="fas fa-external-link-alt"></i> View Profile
    </a>
</div>

<!-- Filter & Sort Bar -->
<div class="filter-sort-container">
    <div class="filter-box">
        <h3 class="section-title">
            <i class="fas fa-filter"></i> Filter Products
        </h3>
        <div class="filter-options">
            <div class="filter-option">
                <input type="checkbox" id="inStockFilter" checked>
                <label for="inStockFilter">In Stock</label>
            </div>
            <div class="filter-option">
                <input type="checkbox" id="lowStockFilter">
                <label for="lowStockFilter">Low Stock</label>
            </div>
            <div class="filter-option">
                <input type="checkbox" id="outOfStockFilter">
                <label for="outOfStockFilter">Out of Stock</label>
            </div>
            <div class="filter-option">
                <input type="checkbox" id="activeFilter" checked>
                <label for="activeFilter">Active Only</label>
            </div>
        </div>
    </div>
    
    <div class="sort-box">
        <h3 class="section-title">
            <i class="fas fa-sort-amount-down"></i> Sort By
        </h3>
        <div class="sort-select-wrapper">
            <select class="sort-select" id="sortSelect">
                <option value="newest">Newest First</option>
                <option value="price_low">Price: Low to High</option>
                <option value="price_high">Price: High to Low</option>
                <option value="name">Name A-Z</option>
                <option value="stock_high">Stock: High to Low</option>
                <option value="stock_low">Stock: Low to High</option>
            </select>
        </div>
    </div>
</div>

<div class="store-container">
    <!-- Products Header -->
    <div class="products-header">
        <div class="product-count">{{ product_count }} products available</div>
        <div class="view-toggle">
            <button class="view-btn grid-view active" id="gridViewBtn" title="Grid View">
                <i class="fas fa-th"></i>
            </button>
            <button class="view-btn list-view" id="listViewBtn" title="List View">
                <i class="fas fa-list"></i>
            </button>
        </div>
    </div>

    <!-- Product Grid -->
    <div class="product-grid" id="productGrid">
        {% for product in products %}
        <div class="product-card" 
             data-price="{{ product.price }}" 
             data-stock="{{ product.stock_quantity }}" 
             data-active="{{ product.is_active|yesno:'true,false' }}" 
             data-date="{{ product.date_added|date:'Y-m-d H:i:s' }}">
             
            <div class="product-image">
                {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                     data-product="{{ product.name }}" data-price="{{ product.price }}">
                {% else %}
                <div class="placeholder-image">No Image Available</div>
                {% endif %}
                
                <!-- Stock Status Badges -->
                <div class="product-badges">
                    {% if not product.is_active %}
                    <span class="badge inactive">Inactive</span>
                    {% elif product.stock_quantity == 0 %}
                    <span class="badge out-of-stock">Out of Stock</span>
                    {% elif product.stock_quantity <= 5 %}
                    <span class="badge low-stock">Low Stock</span>
                    {% else %}
                    <span class="badge in-stock">In Stock</span>
                    {% endif %}
                </div>
                <button class="quick-view-btn" data-product-id="{{ product.id }}">
                    <i class="fas fa-eye"></i> Quick View
                </button>
            </div>

            <div class="product-info">
                <h3 class="product-title">{{ product.name }}</h3>
                <p class="product-description">{{ product.description|truncatewords:20 }}</p>
                
                <!-- Stock Information -->
                <div class="stock-display">
                    {% if product.stock_quantity == 0 %}
                    <div class="stock-status out-of-stock-status">
                        <i class="fas fa-times-circle"></i>
                        <span>Out of Stock</span>
                    </div>
                    {% elif product.stock_quantity <= 5 %}
                    <div class="stock-status low-stock-status">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Only {{ product.stock_quantity }} left</span>
                    </div>
                    {% else %}
                    <div class="stock-status in-stock-status">
                        <i class="fas fa-check-circle"></i>
                        <span>{{ product.stock_quantity }} in stock</span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="product-meta">
                    <div class="product-price">${{ product.price }}</div>
                </div>
                
                <!-- Middleman Note -->
                <div class="middleman-note">
                    <i class="fas fa-info-circle"></i>
                    <span>Shipping handled by seller</span>
                </div>
                
                <!-- Checkout Button -->
                <div class="product-actions">
                    {% if product.stock_quantity > 0 and product.is_active %}
                    <form action="{% url 'initiate_paypal_payment' product.id %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="quantity" value="1">
                        <button type="submit" class="checkout-btn">
                            <i class="fab fa-paypal"></i> Buy with PayPal
                        </button>
                    </form>
                    {% else %}
                    <button class="checkout-btn" disabled>
                        <i class="fas fa-times-circle"></i> Currently Unavailable
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-products">
            <i class="fas fa-box-open"></i>
            <h3>No products found</h3>
            <p>Check back later for new items</p>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    <div class="pagination">
        <button class="page-btn prev" id="prevPage" title="Previous Page">
            <i class="fas fa-chevron-left"></i>
        </button>
        <span class="page-numbers" id="pageInfo">Page 1 of 1</span>
        <button class="page-btn next" id="nextPage" title="Next Page">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<!-- Admin Panel (visible to campaign owner) -->
{% if user == campaign.user.user %}
<div class="admin-panel">
    <div class="panel-toggle" id="adminPanelToggle">
        <i class="fas fa-store"></i> Store Management
        <i class="fas fa-chevron-down toggle-icon"></i>
    </div>
    <div class="form-section" id="adminFormSection">
        <h2 class="form-heading">{% if product %}Edit Product{% else %}Add New Product{% endif %}</h2>
        <form class="product-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-grid">
                {{ form.as_p }}
            </div>
            <button type="submit" class="save-btn"><i class="fas fa-save"></i> Save Product</button>
        </form>
    </div>
</div>
{% endif %}

<!-- Image Popup Modal -->
<div class="modal-overlay" id="imagePopup">
    <div class="modal-container">
        <div class="modal-header">
            <h3 id="popupProductName">Product Name</h3>
            <button class="modal-close" id="closePopup">&times;</button>
        </div>
        <div class="modal-body">
            <div class="modal-image">
                <img src="" alt="Product image" id="popupImage">
            </div>
            <div class="modal-details">
                <div class="modal-price" id="popupPrice">$0.00</div>
                
                <!-- Stock info in modal -->
                <div class="modal-stock-info" id="popupStockInfo">
                    <i class="fas fa-check-circle"></i>
                    <span>In Stock</span>
                </div>
                
                <p class="modal-description" id="popupDescription">Product description will appear here.</p>
                
                <!-- Middleman note in modal -->
                <div class="modal-middleman-note">
                    <i class="fas fa-info-circle"></i>
                    <span>Note: Shipping is handled by the seller.</span>
                </div>
                
                <div class="modal-actions">
                    <!-- PayPal checkout form for modal -->
                    <form id="modalCheckoutForm" method="post" action="{% url 'initiate_paypal_payment' 0 %}">
                        {% csrf_token %}
                        <input type="hidden" id="modalProductId" name="product_id" value="">
                        <input type="hidden" id="modalQuantity" name="quantity" value="1">
                        <button type="submit" class="checkout-btn">
                            <i class="fab fa-paypal"></i> Buy with PayPal
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== QUICK VIEW MODAL FUNCTIONALITY =====
    const quickViewButtons = document.querySelectorAll('.quick-view-btn');
    const imagePopup = document.getElementById('imagePopup');
    const popupImage = document.getElementById('popupImage');
    const popupProductName = document.getElementById('popupProductName');
    const popupPrice = document.getElementById('popupPrice');
    const popupDescription = document.getElementById('popupDescription');
    const closePopup = document.getElementById('closePopup');
    const modalCheckoutForm = document.getElementById('modalCheckoutForm');
    const modalProductIdInput = document.getElementById('modalProductId');
    const popupStockInfo = document.getElementById('popupStockInfo');

    // Quick view button click handler
    quickViewButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const productCard = this.closest('.product-card');
            const productName = productCard.querySelector('.product-title').textContent;
            const productPrice = productCard.querySelector('.product-price').textContent;
            const productDesc = productCard.querySelector('.product-description').textContent;
            const productImg = productCard.querySelector('img') ? productCard.querySelector('img').src : '';
            const productId = this.dataset.productId;
            const stockQuantity = parseInt(productCard.dataset.stock);
            const isActive = productCard.dataset.active === 'true';
            
            // Get the stock status badge
            const stockBadge = productCard.querySelector('.badge');
            let stockStatusText = 'In Stock';
            let stockStatusClass = 'in-stock-status';
            let stockIcon = 'fa-check-circle';
            
            if (stockBadge) {
                if (stockBadge.classList.contains('out-of-stock')) {
                    stockStatusText = 'Out of Stock';
                    stockStatusClass = 'out-of-stock-status';
                    stockIcon = 'fa-times-circle';
                } else if (stockBadge.classList.contains('low-stock')) {
                    stockStatusText = `Only ${stockQuantity} left`;
                    stockStatusClass = 'low-stock-status';
                    stockIcon = 'fa-exclamation-triangle';
                } else if (stockBadge.classList.contains('inactive')) {
                    stockStatusText = 'Inactive';
                    stockStatusClass = 'out-of-stock-status';
                    stockIcon = 'fa-times-circle';
                } else {
                    stockStatusText = `${stockQuantity} in stock`;
                }
            }

            // Update modal content
            popupImage.src = productImg || "{% static 'images/default-product.png' %}";
            popupImage.onerror = function() {
                this.src = "{% static 'images/default-product.png' %}";
            };
            popupProductName.textContent = productName;
            popupPrice.textContent = productPrice;
            popupDescription.textContent = productDesc;

            // Set the product ID in the hidden input
            modalProductIdInput.value = productId;

            // Update the form action URL
            let currentAction = modalCheckoutForm.action;
            modalCheckoutForm.action = currentAction.replace('/0/paypal/', `/${productId}/paypal/`);

            // Update the checkout button in modal
            const checkoutBtn = modalCheckoutForm.querySelector('.checkout-btn');
            if (!isActive || stockQuantity === 0) {
                checkoutBtn.innerHTML = '<i class="fas fa-times-circle"></i> Currently Unavailable';
                checkoutBtn.disabled = true;
            } else {
                checkoutBtn.innerHTML = '<i class="fab fa-paypal"></i> Buy with PayPal';
                checkoutBtn.disabled = false;
            }

            // Update stock info in modal
            popupStockInfo.innerHTML = `<i class="fas ${stockIcon}"></i><span>${stockStatusText}</span>`;
            popupStockInfo.className = `modal-stock-info ${stockStatusClass}`;

            // Show modal
            imagePopup.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
    });

    // Close modal functionality
    closePopup.addEventListener('click', function() {
        imagePopup.classList.remove('active');
        document.body.style.overflow = '';
    });
    
    imagePopup.addEventListener('click', function(e) {
        if (e.target === imagePopup) {
            imagePopup.classList.remove('active');
            document.body.style.overflow = '';
        }
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && imagePopup.classList.contains('active')) {
            imagePopup.classList.remove('active');
            document.body.style.overflow = '';
        }
    });

    // ===== FILTER & SORT FUNCTIONALITY =====
    const sortSelect = document.getElementById('sortSelect');
    const productGrid = document.getElementById('productGrid');
    const productCards = Array.from(document.querySelectorAll('.product-card'));
    
    // Filter checkboxes
    const inStockFilter = document.getElementById('inStockFilter');
    const lowStockFilter = document.getElementById('lowStockFilter');
    const outOfStockFilter = document.getElementById('outOfStockFilter');
    const activeFilter = document.getElementById('activeFilter');

    // Sort functionality
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            sortProducts(this.value);
        });
    }

    function sortProducts(sortBy) {
        const sortedCards = [...productCards];
        
        sortedCards.sort((a, b) => {
            const priceA = parseFloat(a.dataset.price);
            const priceB = parseFloat(b.dataset.price);
            const stockA = parseInt(a.dataset.stock);
            const stockB = parseInt(b.dataset.stock);
            const dateA = new Date(a.dataset.date);
            const dateB = new Date(b.dataset.date);
            const nameA = a.querySelector('.product-title').textContent.toLowerCase();
            const nameB = b.querySelector('.product-title').textContent.toLowerCase();

            switch(sortBy) {
                case 'price_low':
                    return priceA - priceB;
                case 'price_high':
                    return priceB - priceA;
                case 'name':
                    return nameA.localeCompare(nameB);
                case 'stock_high':
                    return stockB - stockA;
                case 'stock_low':
                    return stockA - stockB;
                case 'newest':
                default:
                    return dateB - dateA;
            }
        });

        // Clear and reappend sorted cards
        productGrid.innerHTML = '';
        sortedCards.forEach(card => productGrid.appendChild(card));
        updatePagination();
    }

    // Filter functionality
    function applyFilters() {
        productCards.forEach(card => {
            const stock = parseInt(card.dataset.stock);
            const isActive = card.dataset.active === 'true';
            let shouldShow = true;

            // Stock filters
            if (stock === 0 && !outOfStockFilter.checked) {
                shouldShow = false;
            } else if (stock > 0 && stock <= 5 && !lowStockFilter.checked) {
                shouldShow = false;
            } else if (stock > 5 && !inStockFilter.checked) {
                shouldShow = false;
            }

            // Active filter
            if (!isActive && activeFilter.checked) {
                shouldShow = false;
            }

            card.style.display = shouldShow ? 'flex' : 'none';
        });

        updatePagination();
    }

    // Add event listeners to filter checkboxes
    [inStockFilter, lowStockFilter, outOfStockFilter, activeFilter].forEach(checkbox => {
        if (checkbox) {
            checkbox.addEventListener('change', applyFilters);
        }
    });

    // ===== VIEW TOGGLE =====
    const gridViewBtn = document.getElementById('gridViewBtn');
    const listViewBtn = document.getElementById('listViewBtn');
    
    if (gridViewBtn && listViewBtn) {
        gridViewBtn.addEventListener('click', function() {
            productGrid.classList.remove('list-view');
            gridViewBtn.classList.add('active');
            listViewBtn.classList.remove('active');
        });
        
        listViewBtn.addEventListener('click', function() {
            productGrid.classList.add('list-view');
            listViewBtn.classList.add('active');
            gridViewBtn.classList.remove('active');
        });
    }

    // List view styles
    const style = document.createElement('style');
    style.textContent = `
        .product-grid.list-view {
            grid-template-columns: 1fr;
        }
        
        .product-grid.list-view .product-card {
            flex-direction: row;
            height: auto;
        }
        
        .product-grid.list-view .product-image {
            flex: 0 0 200px;
            height: 180px;
        }
        
        .product-grid.list-view .product-info {
            flex: 1;
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .product-grid.list-view .product-card {
                flex-direction: column;
            }
            
            .product-grid.list-view .product-image {
                flex: none;
                width: 100%;
            }
        }
    `;
    document.head.appendChild(style);

    // ===== PAGINATION =====
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    
    let currentPage = 1;
    const itemsPerPage = window.innerWidth <= 768 ? 6 : 12;
    const totalPages = Math.ceil(productCards.length / itemsPerPage);
    
    function updatePagination() {
        const visibleCards = Array.from(document.querySelectorAll('.product-card'))
            .filter(card => card.style.display !== 'none');
        
        const totalPages = Math.ceil(visibleCards.length / itemsPerPage);
        
        if (pageInfo) {
            pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
        }
        
        if (prevPageBtn) {
            prevPageBtn.disabled = currentPage === 1;
        }
        
        if (nextPageBtn) {
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }
        
        // Show items for current page
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        
        visibleCards.forEach((card, index) => {
            if (index >= startIndex && index < endIndex) {
                card.style.display = 'flex';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    if (prevPageBtn && nextPageBtn) {
        prevPageBtn.addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                updatePagination();
            }
        });
        
        nextPageBtn.addEventListener('click', function() {
            const visibleCards = Array.from(document.querySelectorAll('.product-card'))
                .filter(card => card.style.display !== 'none');
            const totalPages = Math.ceil(visibleCards.length / itemsPerPage);
            
            if (currentPage < totalPages) {
                currentPage++;
                updatePagination();
            }
        });
        
        // Initialize pagination
        updatePagination();
    }

    // ===== ADMIN PANEL TOGGLE =====
    const adminPanelToggle = document.getElementById('adminPanelToggle');
    const adminFormSection = document.getElementById('adminFormSection');
    const toggleIcon = adminPanelToggle ? adminPanelToggle.querySelector('.toggle-icon') : null;
    
    if (adminPanelToggle && adminFormSection) {
        adminPanelToggle.addEventListener('click', function() {
            adminFormSection.classList.toggle('active');
            if (toggleIcon) {
                toggleIcon.classList.toggle('rotated');
            }
        });
    }

    // ===== WINDOW RESIZE HANDLER =====
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            updatePagination();
        }, 250);
    });

    // ===== INITIAL SORT =====
    if (sortSelect) {
        sortSelect.value = 'newest';
        sortProducts('newest');
    }
});
</script>
{% endblock %}