{% extends 'main/face.html' %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="color-scheme" content="light dark">
    <style>
        /* === BASE STYLES === */
        :root {
            --primary: #1da1f2;
            --primary-dark: #1a91da;
            --primary-light: #e8f5fe;
            --secondary: #f5f8fa;
            --text-primary: #14171a;
            --text-secondary: #657786;
            --border: #e1e8ed;
            --card-bg: #ffffff;
            --success: #17bf63;
            --error: #e0245e;
            --warning: #ffad1f;
            --card-shadow: 0 2px 16px rgba(29, 161, 242, 0.08);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --accent-gradient: linear-gradient(135deg, #1da1f2 0%, #1a8cd8 100%);
        }

        /* === DARK MODE === */
        .dark-mode {
            --primary: #1da1f2;
            --primary-dark: #1a91da;
            --primary-light: rgba(29, 161, 242, 0.2);
            --secondary: #0f1720;
            --text-primary: #e8e8e8;
            --text-secondary: #a0aec0;
            --border: #2d3748;
            --card-bg: #1e2736;
            --accent-gradient: linear-gradient(135deg, #1da1f2 0%, #1a8cd8 100%);
            color-scheme: dark;
        }

        .dark-mode .form-input,
        .dark-mode .form-select,
        .dark-mode .form-textarea {
            background-color: #2d3748;
            border-color: var(--border);
            color: var(--text-primary);
        }

        .dark-mode .form-input:focus,
        .dark-mode .form-select:focus,
        .dark-mode .form-textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(29, 161, 242, 0.3);
        }

        .dark-mode .create-card,
        .dark-mode .optional-section,
        .dark-mode .existing-images-section {
            background-color: var(--card-bg);
            border-color: var(--border);
        }

        .dark-mode .optional-header {
            background: #2d3748;
            border-bottom-color: var(--border);
            color: var(--text-primary);
        }

        .dark-mode .optional-header:hover {
            background: #374151;
        }

        .dark-mode .checkbox-group {
            background: rgba(29, 161, 242, 0.05);
            border-color: var(--border);
        }

        /* === LAYOUT STYLES === */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--secondary);
            color: var(--text-primary);
            line-height: 1.5;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .create-wrapper {
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .create-container {
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
        }

        /* === HEADER === */
        .create-header {
            text-align: center;
            margin-bottom: 32px;
            padding: 0 16px;
        }

        .create-header h1 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
            font-weight: 800;
            font-size: 32px;
            line-height: 1.2;
        }

        .create-header p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 17px;
            max-width: 400px;
            margin: 0 auto;
        }

        /* === FORM STYLES === */
        .core-form {
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 15px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: inherit;
            font-size: 16px;
            background-color: white;
            box-sizing: border-box;
            transition: var(--transition);
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(29, 161, 242, 0.1);
        }

        .form-textarea {
            min-height: 140px;
            resize: vertical;
            line-height: 1.6;
        }

        .form-helper {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 6px;
            display: block;
        }

        /* === EXISTING IMAGES SECTION === */
        .existing-images-section {
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--border);
            aspect-ratio: 1;
            transition: var(--transition);
        }

        .image-item.main-image {
            border-color: var(--primary);
            border-width: 3px;
            box-shadow: 0 0 0 1px var(--primary);
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            text-align: center;
        }

        .image-controls {
            position: absolute;
            top: 8px;
            left: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 10px;
            border-radius: 6px;
        }

        .remove-checkbox {
            accent-color: #e0245e;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .remove-label {
            color: white;
            font-size: 12px;
            cursor: pointer;
            user-select: none;
        }

        /* === IMAGE REMOVAL STATES === */
        .image-item.marked-for-removal {
            opacity: 0.6;
            border-color: var(--error);
            background: repeating-linear-gradient(
                45deg,
                rgba(224, 36, 94, 0.1),
                rgba(224, 36, 94, 0.1) 10px,
                transparent 10px,
                transparent 20px
            );
        }

        .image-item.marked-for-removal img {
            filter: grayscale(80%) brightness(0.7);
        }

        .image-item.marked-for-removal .image-label {
            background: rgba(224, 36, 94, 0.8);
        }

        /* === WARNING NOTES === */
        .warning-note {
            background: rgba(255, 173, 31, 0.1);
            border: 1px solid rgba(255, 173, 31, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin: 16px 0;
            color: var(--warning);
            font-size: 14px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .warning-note i {
            color: var(--warning);
            margin-top: 2px;
        }

        /* === OPTIONAL SECTION === */
        .optional-section {
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 0;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .optional-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
            user-select: none;
        }

        .optional-header:hover {
            background: #f0f5fa;
        }

        .optional-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .optional-header i {
            transition: transform 0.2s ease;
            color: var(--primary);
        }

        .optional-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .optional-content.expanded {
            padding: 24px;
            max-height: 2000px;
        }

        .optional-field {
            margin-bottom: 20px;
        }

        /* === CHECKBOX GROUPS === */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: rgba(29, 161, 242, 0.05);
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .checkbox-group:hover {
            background: rgba(29, 161, 242, 0.08);
        }

        .checkbox-group label {
            cursor: pointer;
            font-size: 15px;
            color: var(--text-primary);
            user-select: none;
            flex: 1;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .checkbox-group.remove-option label {
            color: var(--error);
        }

        .checkbox-group.remove-option input[type="checkbox"] {
            accent-color: var(--error);
        }

        /* === FILE UPLOAD === */
        .file-upload {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: #fafbfd;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .file-upload i {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .file-upload-text {
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .file-upload-helper {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
            display: block;
        }

        /* === NEW IMAGES PREVIEW === */
        .new-images-preview {
            margin-top: 20px;
        }

        .preview-label {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
            display: block;
            font-size: 14px;
        }

        /* === BUTTONS === */
        .publish-section {
            text-align: center;
            margin-top: 32px;
        }

        .publish-button {
            background: var(--accent-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 48px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(29, 161, 242, 0.2);
        }

        .publish-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(29, 161, 242, 0.3);
        }

        .reassurance-text {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 12px;
            display: block;
        }

        .cancel-button {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 14px 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-right: 16px;
        }

        .cancel-button:hover {
            background: rgba(101, 119, 134, 0.1);
            border-color: var(--text-secondary);
        }

        /* === ERROR HANDLING === */
        .error-container {
            background-color: rgba(224, 36, 94, 0.05);
            border-left: 4px solid var(--error);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
            color: var(--error);
            font-size: 14px;
        }

        .error-container strong {
            display: block;
            margin-bottom: 8px;
            color: var(--error);
        }

        .error-container ul {
            margin: 0;
            padding-left: 20px;
        }

        .error-container li {
            margin-bottom: 4px;
        }

        /* === TWO COLUMN LAYOUT === */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* === CURRENT AUDIO SECTION === */
        .current-audio-section {
            margin-bottom: 24px;
        }

        .audio-player-container {
            padding: 16px;
            background: rgba(29, 161, 242, 0.05);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-top: 8px;
            transition: var(--transition);
        }

        .audio-player-container audio {
            width: 100%;
            border-radius: 8px;
        }

        .audio-player-container.marked-for-removal {
            opacity: 0.5;
            filter: grayscale(100%);
            background: repeating-linear-gradient(
                45deg,
                rgba(224, 36, 94, 0.1),
                rgba(224, 36, 94, 0.1) 10px,
                transparent 10px,
                transparent 20px
            );
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .create-wrapper {
                padding: 16px 12px;
            }

            .core-form,
            .existing-images-section,
            .optional-section {
                padding: 20px;
            }

            .create-header h1 {
                font-size: 28px;
            }

            .two-column {
                grid-template-columns: 1fr;
            }

            .images-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 12px;
            }

            .publish-button,
            .cancel-button {
                padding: 14px 24px;
                font-size: 16px;
            }

            .cancel-button {
                margin-right: 12px;
                margin-bottom: 12px;
            }
        }

        @media (max-width: 480px) {
            .images-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .checkbox-group {
                padding: 10px 12px;
            }
            
            .file-upload {
                padding: 16px;
            }
        }
    </style>
</head>

<body>
    <div class="create-wrapper">
        <div class="create-container">

            <!-- Header -->
            <div class="create-header">
                <h1>Edit Campaign</h1>
                <p>Update your campaign to keep your supporters informed.</p>
            </div>

            <!-- Main form -->
            <form method="post" enctype="multipart/form-data" id="campaignForm">
                {% csrf_token %}
                
                <!-- Hidden field to track existing images -->
                <input type="hidden" name="existing_images_data" id="existingImagesData" 
                       value="{{ existing_images_json|default:'[]' }}">

                <!-- Error Display -->
                {% if form.errors %}
                <div class="error-container">
                    <strong>Let's fix a few things:</strong>
                    <ul>
                        {% for field in form %}
                        {% for error in field.errors %}
                        <li>{{ field.label }}: {{ error }}</li>
                        {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Current Images Section -->
                {% if existing_images %}
                <div class="existing-images-section">
                    <h3>Current Images</h3>
                    <p class="form-helper">Check images you want to remove. Unchecked images will be kept automatically.</p>
                    
                    <!-- Warning note -->
                    <div class="warning-note">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Important:</strong> Images will only be removed if you check them below. 
                            Leaving them unchecked means they'll stay in your campaign.
                        </div>
                    </div>

                    <!-- Main Poster Checkbox (REMOVE OPTION) -->
                    {% if existing_campaign.poster %}
                    <div class="checkbox-group remove-option">
                        <input type="checkbox" id="remove_current_poster" name="remove_current_poster">
                        <label for="remove_current_poster">
                            <i class="fas fa-trash-alt"></i> Remove current main image
                        </label>
                    </div>
                    {% endif %}

                    <!-- Images Grid -->
                    <div class="images-grid">
                        {% for image in existing_images %}
                        <div class="image-item {% if image.is_main %}main-image{% endif %}" 
                             id="existing-image-{{ image.index }}">
                            <img src="{{ image.url }}" alt="Campaign image {{ image.index }}"
                                onerror="this.src='{% static 'images/default-campaign.png' %}'">
                            <div class="image-label">
                                {% if image.is_main %}Main Image{% else %}Slide {{ image.index }}{% endif %}
                            </div>
                            {% if not image.is_main %}
                            <div class="image-controls">
                                <input type="checkbox" 
                                       id="remove_existing_image_{{ image.index }}" 
                                       name="remove_existing_image_{{ image.index }}" 
                                       class="remove-checkbox"
                                       data-index="{{ image.index }}">
                                <label for="remove_existing_image_{{ image.index }}" class="remove-label">
                                    Remove
                                </label>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Remove All Additional Images Checkbox -->
                    {% if has_additional_images %}
                    <div class="checkbox-group remove-option" style="margin-top: 20px;">
                        <input type="checkbox" id="remove_all_additional" name="remove_all_additional">
                        <label for="remove_all_additional">
                            <i class="fas fa-trash-alt"></i> Remove all additional images
                        </label>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Current Audio Section -->
                {% if has_audio and existing_campaign.audio %}
                <div class="existing-images-section current-audio-section">
                    <h3>Current Audio</h3>
                    <p class="form-helper">Your campaign currently has audio. Upload a new file to replace it or check below to remove.</p>
                    
                    <!-- Audio removal checkbox -->
                    <div class="checkbox-group remove-option" style="margin-bottom: 16px;">
                        <input type="checkbox" id="remove_current_audio" name="remove_current_audio">
                        <label for="remove_current_audio">
                            <i class="fas fa-trash-alt"></i> Remove current audio
                        </label>
                    </div>
                    
                    <div class="audio-player-container" id="currentAudioContainer">
                        <audio controls>
                            <source src="{{ existing_campaign.audio }}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                        <div style="margin-top: 8px; font-size: 14px; color: var(--text-secondary); text-align: center;">
                            Current audio file
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Core Form -->
                <div class="core-form">
                    <!-- Title -->
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" 
                               name="title" 
                               class="form-input" 
                               placeholder="What are you trying to change?"
                               required 
                               value="{{ form.title.value|default:existing_campaign.title }}">
                        <span class="form-helper">Make it clear and compelling</span>
                    </div>

                    <!-- Description -->
                    <div class="form-group">
                        <label class="form-label">What's going on?</label>
                        <textarea name="content" 
                                  class="form-textarea"
                                  placeholder="Tell people what's happening and what you're trying to do."
                                  required>{{ form.content.value|default:existing_campaign.content }}</textarea>
                        <span class="form-helper">Share your story and goals</span>
                    </div>

                    <!-- Category -->
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-select" required>
                            {% for category in categories %}
                            <option value="{{ category.0 }}"
                                {% if form.category.value|default:existing_campaign.category == category.0 %}selected{% endif %}>
                                {{ category.1 }}
                            </option>
                            {% endfor %}
                        </select>
                        <span class="form-helper">Helps people find your cause</span>
                    </div>
                </div>

                <!-- Optional Section -->
                <div class="optional-section">
                    <div class="optional-header" id="optionalToggle">
                        <h3>▸ Update media & details (optional)</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>

                    <div class="optional-content" id="optionalContent">
                        <!-- New Main Image -->
                        <div class="optional-field">
                            <label class="form-label">Upload New Main Image</label>
                            <div class="file-upload" id="mainImageUpload">
                                <i class="fas fa-image"></i>
                                <div class="file-upload-text">Choose a new main image</div>
                                <span class="file-upload-helper">
                                    {% if existing_campaign.poster %}
                                    Will replace current main image unless you checked "Remove current main image"
                                    {% else %}
                                    Add a main image to your campaign
                                    {% endif %}
                                </span>
                                <input type="file" 
                                       name="poster" 
                                       id="id_poster" 
                                       accept="image/*" 
                                       style="display: none;">
                            </div>
                            <div id="mainPosterPreview" class="new-images-preview"></div>
                        </div>

                        <!-- Additional Images -->
                        <div class="optional-field">
                            <label class="form-label">Add More Images</label>
                            <div class="file-upload" id="additionalImagesUpload">
                                <i class="fas fa-layer-group"></i>
                                <div class="file-upload-text">Add new images to slideshow</div>
                                <span class="file-upload-helper">
                                    Select multiple images (up to 4 total with existing)
                                </span>
                                <input type="file" 
                                       name="additional_images" 
                                       id="id_additional_images" 
                                       accept="image/*" 
                                       multiple 
                                       style="display: none;">
                            </div>
                            <div id="additionalPreviews" class="new-images-preview"></div>
                        </div>

                        <!-- New Audio -->
                        <div class="optional-field">
                            <label class="form-label">{% if has_audio %}Replace{% else %}Add{% endif %} Audio</label>
                            <div class="file-upload" id="audioUpload">
                                <i class="fas fa-music"></i>
                                <div class="file-upload-text">
                                    {% if has_audio %}Upload new audio file{% else %}Add audio to your campaign{% endif %}
                                </div>
                                <span class="file-upload-helper">
                                    Supported formats: MP3, WAV, OGG
                                </span>
                                <input type="file" 
                                       name="audio" 
                                       id="id_audio" 
                                       accept="audio/*" 
                                       style="display: none;">
                            </div>
                            <div id="audioPreview" class="new-images-preview"></div>
                        </div>

                        <!-- Visibility & Tags -->
                        <div class="two-column">
                            <div class="optional-field">
                                <label class="form-label">Visibility</label>
                                <select name="visibility" class="form-select">
                                    <option value="public"
                                        {% if form.visibility.value|default:existing_campaign.visibility == 'public' %}selected{% endif %}>
                                        Public (Everyone can see)
                                    </option>
                                    <option value="private"
                                        {% if form.visibility.value|default:existing_campaign.visibility == 'private' %}selected{% endif %}>
                                        Private (Invite only)
                                    </option>
                                </select>
                            </div>

                            <div class="optional-field">
                                <label class="form-label">Tags</label>
                                <input type="text" 
                                       name="tags_input" 
                                       class="form-input"
                                       placeholder="environment, education, health..."
                                       value="{{ form.tags_input.value|default:'' }}">
                                <span class="form-helper">Separate with commas</span>
                            </div>
                        </div>

                        <!-- Timeframe -->
                        <div class="optional-field">
                            <label class="form-label">Timeframe</label>
                            <div class="two-column">
                                <input type="number" 
                                       name="duration" 
                                       class="form-input" 
                                       min="1"
                                       placeholder="e.g. 30"
                                       value="{{ form.duration.value|default:existing_campaign.duration }}">
                                <select name="duration_unit" class="form-select">
                                    <option value=""
                                        {% if not existing_campaign.duration_unit %}selected{% endif %}>
                                        No limit
                                    </option>
                                    <option value="days"
                                        {% if existing_campaign.duration_unit == 'days' %}selected{% endif %}>
                                        Days
                                    </option>
                                    <option value="weeks"
                                        {% if existing_campaign.duration_unit == 'weeks' %}selected{% endif %}>
                                        Weeks
                                    </option>
                                </select>
                            </div>
                            <span class="form-helper">Leave empty for ongoing campaigns</span>
                        </div>

                        <!-- Funding Goal -->
                        <div class="optional-field">
                            <label class="form-label">Funding Goal</label>
                            <input type="number" 
                                   name="funding_goal" 
                                   class="form-input" 
                                   min="0" 
                                   step="0.01"
                                   placeholder="0.00"
                                   value="{{ form.funding_goal.value|default:existing_campaign.funding_goal }}">
                            <span class="form-helper">Set to 0 for non-fundraising campaigns</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="publish-section">
                    <button type="button" class="cancel-button"
                        onclick="window.location.href='{% url 'view_campaign' campaign_id=existing_campaign.id %}'">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="publish-button">
                        <i class="fas fa-save"></i> Update Campaign
                    </button>
                    <span class="reassurance-text">Your supporters will see the changes immediately</span>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Toggle optional section
        document.getElementById('optionalToggle').addEventListener('click', function () {
            const content = document.getElementById('optionalContent');
            content.classList.toggle('expanded');
            this.classList.toggle('expanded');
            
            if (content.classList.contains('expanded')) {
                this.querySelector('h3').innerHTML = '▾ Update media & details (optional)';
            } else {
                this.querySelector('h3').innerHTML = '▸ Update media & details (optional)';
            }
        });

        // Image preview functionality
        function previewMainImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('mainPosterPreview');
                    preview.innerHTML = `
                        <span class="preview-label">New main image preview:</span>
                        <div class="images-grid">
                            <div class="image-item main-image">
                                <img src="${e.target.result}" alt="New main image">
                                <div class="image-label">New Main</div>
                            </div>
                        </div>
                    `;
                    
                    // If user uploads new main image, automatically uncheck "remove current"
                    const removeMainCheckbox = document.getElementById('remove_current_poster');
                    if (removeMainCheckbox) {
                        removeMainCheckbox.checked = false;
                        const mainImage = document.querySelector('.image-item.main-image');
                        if (mainImage) {
                            mainImage.classList.remove('marked-for-removal');
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function previewAdditionalImages(event) {
            const files = Array.from(event.target.files);
            const previewContainer = document.getElementById('additionalPreviews');
            previewContainer.innerHTML = '<span class="preview-label">New additional images preview:</span>';
            
            const grid = document.createElement('div');
            grid.className = 'images-grid';
            
            files.slice(0, 4).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const div = document.createElement('div');
                    div.className = 'image-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Additional image ${index + 1}">
                        <div class="image-label">New Slide ${index + 1}</div>
                    `;
                    grid.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
            
            previewContainer.appendChild(grid);
            
            // If user uploads new images, uncheck "remove all"
            const removeAllCheckbox = document.getElementById('remove_all_additional');
            if (removeAllCheckbox) {
                removeAllCheckbox.checked = false;
                removeAllCheckbox.indeterminate = false;
            }
        }

        // Audio preview
        function previewAudio(event) {
            const file = event.target.files[0];
            if (file) {
                const preview = document.getElementById('audioPreview');
                const url = URL.createObjectURL(file);
                preview.innerHTML = `
                    <span class="preview-label">Audio preview:</span>
                    <div class="audio-player-container">
                        <audio controls src="${url}"></audio>
                        <div style="margin-top: 8px; font-size: 14px; color: var(--text-secondary)">
                            <i class="fas fa-check-circle"></i> ${file.name}
                            <br><small>Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                        </div>
                    </div>
                `;
                
                // When user uploads new audio, automatically uncheck "remove current audio"
                const removeAudioCheckbox = document.getElementById('remove_current_audio');
                if (removeAudioCheckbox) {
                    removeAudioCheckbox.checked = false;
                    const audioContainer = document.getElementById('currentAudioContainer');
                    if (audioContainer) {
                        audioContainer.classList.remove('marked-for-removal');
                    }
                }
            }
        }

        // Setup image removal logic
        function setupImageRemovalLogic() {
            // Main poster removal
            const removeMainPoster = document.getElementById('remove_current_poster');
            if (removeMainPoster) {
                removeMainPoster.addEventListener('change', function() {
                    const mainImage = document.querySelector('.image-item.main-image');
                    if (mainImage) {
                        mainImage.classList.toggle('marked-for-removal', this.checked);
                    }
                });
            }
            
            // Additional images removal
            const removeCheckboxes = document.querySelectorAll('.remove-checkbox');
            removeCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const index = this.getAttribute('data-index');
                    const imageDiv = document.getElementById(`existing-image-${index}`);
                    if (imageDiv) {
                        imageDiv.classList.toggle('marked-for-removal', this.checked);
                    }
                    updateRemoveAllCheckbox();
                });
            });
            
            // "Remove all additional" checkbox
            const removeAllAdditional = document.getElementById('remove_all_additional');
            if (removeAllAdditional && removeCheckboxes.length > 0) {
                removeAllAdditional.addEventListener('change', function() {
                    removeCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                        const index = checkbox.getAttribute('data-index');
                        const imageDiv = document.getElementById(`existing-image-${index}`);
                        if (imageDiv) {
                            imageDiv.classList.toggle('marked-for-removal', this.checked);
                        }
                    });
                });
                
                // Update "remove all" checkbox state
                function updateRemoveAllCheckbox() {
                    const allChecked = Array.from(removeCheckboxes).every(cb => cb.checked);
                    const someChecked = Array.from(removeCheckboxes).some(cb => cb.checked);
                    
                    removeAllAdditional.checked = allChecked;
                    removeAllAdditional.indeterminate = someChecked && !allChecked;
                }
                
                // Initialize
                updateRemoveAllCheckbox();
            }
            
            // Audio removal logic
            const removeAudioCheckbox = document.getElementById('remove_current_audio');
            if (removeAudioCheckbox) {
                removeAudioCheckbox.addEventListener('change', function() {
                    const audioContainer = document.getElementById('currentAudioContainer');
                    if (audioContainer) {
                        audioContainer.classList.toggle('marked-for-removal', this.checked);
                    }
                });
            }
        }
        
        // Audio validation
        function validateAudioFile(file) {
            const validTypes = ['audio/mpeg', 'audio/wav', 'audio/ogg', 'audio/mp3'];
            const maxSize = 50 * 1024 * 1024; // 50MB
            
            if (!validTypes.includes(file.type)) {
                alert('Please upload a valid audio file (MP3, WAV, or OGG)');
                return false;
            }
            
            if (file.size > maxSize) {
                alert('Audio file is too large. Maximum size is 50MB.');
                return false;
            }
            
            return true;
        }
        
        // Form validation
        function validateForm(event) {
            const audioInput = document.getElementById('id_audio');
            const removeAudioCheckbox = document.getElementById('remove_current_audio');
            
            // Check audio file if uploaded
            if (audioInput.files.length > 0) {
                const audioFile = audioInput.files[0];
                if (!validateAudioFile(audioFile)) {
                    audioInput.value = '';
                    event.preventDefault();
                    return false;
                }
            }
            
            // Confirm if removing audio without uploading new
            if (removeAudioCheckbox && removeAudioCheckbox.checked && 
                (!audioInput || audioInput.files.length === 0)) {
                if (!confirm("You're removing the current audio without uploading a new one. Continue?")) {
                    event.preventDefault();
                    return false;
                }
            }
            
            // Confirm if removing all images without uploading new ones
            const removeMain = document.getElementById('remove_current_poster');
            const removeAllAdditional = document.getElementById('remove_all_additional');
            const newPoster = document.getElementById('id_poster').files.length;
            const newAdditional = document.getElementById('id_additional_images').files.length;
            
            if ((removeMain && removeMain.checked) && 
                (removeAllAdditional && removeAllAdditional.checked) && 
                newPoster === 0 && newAdditional === 0) {
                if (!confirm("You're removing all existing images without uploading new ones. Your campaign will have no images. Continue?")) {
                    event.preventDefault();
                    return false;
                }
            }
            
            return true;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            // Setup image previews
            const posterInput = document.getElementById('id_poster');
            if (posterInput) {
                posterInput.addEventListener('change', previewMainImage);
                document.getElementById('mainImageUpload').addEventListener('click', function() {
                    posterInput.click();
                });
            }
            
            const additionalInput = document.getElementById('id_additional_images');
            if (additionalInput) {
                additionalInput.addEventListener('change', previewAdditionalImages);
                document.getElementById('additionalImagesUpload').addEventListener('click', function() {
                    additionalInput.click();
                });
            }
            
            // Setup audio preview
            const audioInput = document.getElementById('id_audio');
            if (audioInput) {
                audioInput.addEventListener('change', previewAudio);
                document.getElementById('audioUpload').addEventListener('click', function() {
                    audioInput.click();
                });
            }
            
            // Setup image and audio removal logic
            setupImageRemovalLogic();
            
            // Auto-expand optional section if there are errors
            {% if form.errors %}
            const optionalToggle = document.getElementById('optionalToggle');
            if (optionalToggle) {
                optionalToggle.click();
            }
            {% endif %}
            
            // Add form validation on submit
            const form = document.getElementById('campaignForm');
            form.addEventListener('submit', validateForm);
        });
    </script>

</body>
</html>
{% endblock content %}