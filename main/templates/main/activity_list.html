{% extends 'main/face.html' %}

{% load custom_filters %}
{% load static %}  

{% block content %}
<!-- Include FontAwesome CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ============================================= */
/* CSS VARIABLES - LIGHT MODE (DEFAULT)         */
/* ============================================= */

:root {
  /* Light mode colors - exactly as they were originally */
  --bg-primary: #0A1929;
  --bg-secondary: #1A2A3A;
  --bg-overlay: rgba(10, 25, 41, 0.95);
  --bg-progress: rgba(0, 0, 0, 0.4);
  --bg-dots: rgba(0,0,0,0.3);
  --text-primary: #ffffff;
  --text-secondary: rgba(255,255,255,0.6);
  --text-tertiary: rgba(255,255,255,0.7);
  --text-muted: rgba(255,255,255,0.8);
  --accent-color: #1DA1F2;
  --accent-gradient: linear-gradient(90deg, #1DA1F2, #64B5F6);
  --border-light: rgba(255,255,255,0.1);
  --border-medium: rgba(255,255,255,0.15);
  --overlay-gradient: linear-gradient(180deg, rgba(0,0,0,0.7) 0%, transparent 100%);
  --overlay-gradient-bottom: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.5) 70%, transparent 100%);
  --empty-bg: linear-gradient(145deg, #0A1929, #1A2A3A);
  --heart-color: #E0245E;
  --drawer-bg: #ffffff;
  --drawer-text: #0A1929;
  --drawer-secondary: #657786;
  --drawer-border: rgba(0,0,0,0.05);
  --drawer-input-bg: #F5F8FA;
  --shadow-color: rgba(0, 0, 0, 0.1);
  --shadow-color-strong: rgba(0, 0, 0, 0.15);
  --button-bg: rgba(255,255,255,0.1);
}

/* ============================================= */
/* DARK MODE OVERRIDES - Using your formula      */
/* ============================================= */

body.dark-mode {
  --bg-primary: #121212;
  --bg-secondary: #1e1e1e;
  --bg-overlay: rgba(30, 30, 30, 0.95);
  --bg-progress: rgba(0, 0, 0, 0.6);
  --bg-dots: rgba(0, 0, 0, 0.5);
  --text-primary: #ffffff;
  --text-secondary: #bbbbbb;
  --text-tertiary: #bbbbbb;
  --text-muted: #888888;
  --accent-color: #1DA1F2;
  --accent-gradient: linear-gradient(90deg, #1DA1F2, #64B5F6);
  --border-light: #444444;
  --border-medium: #444444;
  --overlay-gradient: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
  --overlay-gradient-bottom: linear-gradient(0deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.7) 70%, transparent 100%);
  --empty-bg: linear-gradient(145deg, #121212, #1e1e1e);
  --heart-color: #E0245E;
  --drawer-bg: #1e1e1e;
  --drawer-text: #ffffff;
  --drawer-secondary: #bbbbbb;
  --drawer-border: #444444;
  --drawer-input-bg: #2d2d2d;
  --shadow-color: rgba(0, 0, 0, 0.3);
  --shadow-color-strong: rgba(0, 0, 0, 0.4);
  --button-bg: rgba(255,255,255,0.1);
}

/* ============================================= */
/* DEFAULT STYLES - USING CSS VARIABLES          */
/* ============================================= */

.journey-stories {
    width: 100%;
    max-width: 100%;
    background: var(--bg-primary);
    min-height: 100vh;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    margin: 0;
    padding: 0;
    position: relative;
    left: 0;
    right: 0;
}

.journey-stories .stories-header {
    padding: 12px 16px;
    background: var(--bg-overlay);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border-light);
    width: 100%;
}

.journey-stories .day-progress-container {
    padding: 8px 16px;
    background: var(--bg-progress);
    backdrop-filter: blur(8px);
    position: sticky;
    top: 64px;
    z-index: 45;
    width: 100%;
}

.journey-stories .progress-dots {
    padding: 8px 16px;
    display: flex;
    gap: 4px;
    justify-content: center;
    background: var(--bg-dots);
    width: 100%;
}

.journey-stories .story-media-container {
    position: relative;
    width: 100%;
    height: 100vh;
    background: #000;
    overflow: hidden;
}

.journey-stories .story-media {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
}

.journey-stories .media-meta {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    padding: 16px;
    background: var(--overlay-gradient);
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-primary);
    width: 100%;
}

.journey-stories .day-badge {
    position: absolute;
    top: 16px;
    right: 16px;
    padding: 6px 14px;
    background: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(4px);
    border-radius: 100px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 6px;
    border: 1px solid var(--border-medium);
    font-size: 13px;
    font-weight: 600;
}

.journey-stories .story-content-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 20px 16px;
    background: var(--overlay-gradient-bottom);
    color: var(--text-primary);
    width: 100%;
}

.journey-stories .story-actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 16px;
    width: 100%;
}

.journey-stories .action-group {
    display: flex;
    align-items: center;
    gap: 24px;
}

.journey-stories .comments-drawer {
    padding: 20px;
    background: var(--drawer-bg);
    width: 100%;
    max-height: 60vh;
    overflow-y: auto;
    color: var(--drawer-text);
}

.journey-stories .create-story-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    background: var(--accent-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-primary);
    font-size: 22px;
    text-decoration: none;
    box-shadow: 0 4px 12px rgba(29, 161, 242, 0.4);
    z-index: 100;
}

.journey-stories .empty-story {
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--empty-bg);
    color: var(--text-primary);
    text-align: center;
    min-height: 100vh;
    width: 100%;
}

.journey-stories .mobile-popup-menu {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 20px;
    background: var(--drawer-bg);
    border-radius: 20px 20px 0 0;
    z-index: 1000;
    transform: translateY(100%);
    transition: transform 0.3s ease;
    box-shadow: 0 -4px 20px var(--shadow-color);
    width: 100%;
}

.journey-stories .mobile-popup-menu.show {
    transform: translateY(0);
}

.journey-stories .stories-feed {
    display: flex;
    flex-direction: column;
    gap: 0;
    width: 100%;
}

.journey-stories .story-card {
    width: 100%;
    background: #000;
}

.journey-stories .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-secondary);
}

.journey-stories .dot.active {
    width: 18px;
    background: var(--accent-color);
    border-radius: 3px;
}

.journey-stories .loved i {
    color: var(--heart-color) !important;
}

/* ============================================= */
/* MOBILE ONLY - EDGE TO EDGE                    */
/* ============================================= */

@media only screen and (max-width: 768px) {
    
    /* Make journey-stories edge to edge */
    .journey-stories {
        width: 100vw !important;
        max-width: 100vw !important;
        margin-left: calc(-50vw + 50%) !important;
        margin-right: calc(-50vw + 50%) !important;
        left: 0 !important;
        right: 0 !important;
        position: relative !important;
    }
    
    /* All journey-stories children should be edge-to-edge */
    .journey-stories > * {
        width: 100% !important;
        max-width: 100% !important;
    }
    
    /* Header - proper padding */
    .journey-stories .stories-header {
        padding: 12px 16px !important;
        width: 100% !important;
        margin: 0 !important;
    }
    
    /* Progress container */
    .journey-stories .day-progress-container {
        padding: 8px 16px !important;
        width: 100% !important;
        margin: 0 !important;
    }
    
    /* Progress dots */
    .journey-stories .progress-dots {
        padding: 12px 16px !important;
        width: 100% !important;
        margin: 0 !important;
        display: flex !important;
        gap: 4px !important;
        justify-content: center !important;
    }
    
    /* Story card */
    .journey-stories .story-card {
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    /* Media container */
    .journey-stories .story-media-container {
        width: 100% !important;
        height: 100vh !important;
        height: calc(var(--vh, 1vh) * 100) !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    /* Media meta overlay */
    .journey-stories .media-meta {
        padding: 16px !important;
        width: 100% !important;
        margin: 0 !important;
    }
    
    /* Content overlay */
    .journey-stories .story-content-overlay {
        padding: 20px 16px !important;
        width: 100% !important;
        margin: 0 !important;
    }
    
    /* Comments drawer */
    .journey-stories .comments-drawer {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 20px 16px !important;
        background: var(--drawer-bg) !important;
        border-radius: 20px 20px 0 0 !important;
        z-index: 1000 !important;
        max-height: 70vh !important;
        overflow-y: auto !important;
        box-shadow: 0 -4px 20px var(--shadow-color-strong) !important;
    }
    
    /* Create button */
    .journey-stories .create-story-btn {
        position: fixed !important;
        bottom: 20px !important;
        right: 20px !important;
        width: 56px !important;
        height: 56px !important;
        margin: 0 !important;
        padding: 0 !important;
        z-index: 100 !important;
    }
    
    /* Mobile menu */
    .journey-stories .mobile-popup-menu {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 20px 16px !important;
        background: var(--drawer-bg) !important;
        border-radius: 20px 20px 0 0 !important;
        z-index: 2000 !important;
        box-shadow: 0 -4px 20px var(--shadow-color-strong) !important;
    }
    
    /* Empty state */
    .journey-stories .empty-story {
        min-height: 100vh !important;
        min-height: calc(var(--vh, 1vh) * 100) !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 20px 16px !important;
    }
    
    /* Stories feed */
    .journey-stories .stories-feed {
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    /* Safe area support */
    @supports (padding: max(0px)) {
        .journey-stories .stories-header {
            padding-top: max(12px, env(safe-area-inset-top, 12px)) !important;
            padding-left: max(16px, env(safe-area-inset-left, 16px)) !important;
            padding-right: max(16px, env(safe-area-inset-right, 16px)) !important;
        }
        
        .journey-stories .day-progress-container {
            padding-left: max(16px, env(safe-area-inset-left, 16px)) !important;
            padding-right: max(16px, env(safe-area-inset-right, 16px)) !important;
        }
        
        .journey-stories .progress-dots {
            padding-left: max(16px, env(safe-area-inset-left, 16px)) !important;
            padding-right: max(16px, env(safe-area-inset-right, 16px)) !important;
        }
        
        .journey-stories .story-content-overlay {
            padding-bottom: max(20px, env(safe-area-inset-bottom, 20px)) !important;
            padding-left: max(16px, env(safe-area-inset-left, 16px)) !important;
            padding-right: max(16px, env(safe-area-inset-right, 16px)) !important;
        }
        
        .journey-stories .media-meta {
            padding-left: max(16px, env(safe-area-inset-left, 16px)) !important;
            padding-right: max(16px, env(safe-area-inset-right, 16px)) !important;
            padding-top: max(16px, env(safe-area-inset-top, 16px)) !important;
        }
        
        .journey-stories .day-badge {
            top: max(16px, env(safe-area-inset-top, 16px)) !important;
            right: max(16px, env(safe-area-inset-right, 16px)) !important;
        }
        
        .journey-stories .comments-drawer {
            padding-left: max(16px, env(safe-area-inset-left, 16px)) !important;
            padding-right: max(16px, env(safe-area-inset-right, 16px)) !important;
            padding-bottom: max(20px, env(safe-area-inset-bottom, 20px)) !important;
        }
        
        .journey-stories .create-story-btn {
            bottom: max(20px, env(safe-area-inset-bottom, 20px)) !important;
            right: max(20px, env(safe-area-inset-right, 20px)) !important;
        }
    }
}


/* Add to your existing CSS */
.journey-stories .video-paused::after {
    content: '⏸';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 60px;
    color: white;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    opacity: 0.8;
    pointer-events: none;
    z-index: 10;
    animation: fadeOut 0.5s ease forwards;
}

@keyframes fadeOut {
    0% { opacity: 0.8; }
    70% { opacity: 0.8; }
    100% { opacity: 0; }
}

.journey-stories .story-media-container {
    position: relative;
    width: 100%;
    height: 100vh;
    background: #000;
    overflow: hidden;
    cursor: pointer;
}
</style>

<!-- ============================================= -->
<!-- JOURNEY STORIES - HTML                        -->
<!-- ============================================= -->

<div class="journey-stories">
    
  
    <!-- === DAY PROGRESS === -->
    <div class="day-progress-container">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
            <span style="color: var(--text-primary); font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                <i class="fas fa-flag" style="color: var(--accent-color);"></i>
                {% if activity_count > 0 %}
                    Day {{ activity_count }}
                {% else %}
                    Day 1
                {% endif %}
            </span>
            <span style="color: var(--text-tertiary); font-size: 12px;">{{ activity_count }} / 30</span>
        </div>
        <div style="width: 100%; height: 4px; background: var(--border-light); border-radius: 2px; overflow: hidden; margin-top: 6px;">
            <div style="height: 100%; background: var(--accent-gradient); border-radius: 2px; width: {{ progress_percentage|default:"0" }}%;"></div>
        </div>
    </div>
    
    <!-- === PROGRESS DOTS === -->
    {% if activities %}
    <div class="progress-dots">
        {% for activity in activities %}
            <span class="dot {% if forloop.last %}active{% endif %}"></span>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- === STORIES FEED === -->
    {% if activities %}
        <div class="stories-feed">
            {% for activity in activities %}
                <div class="story-card" id="story-{{ activity.id }}">
                    
                    <!-- === MEDIA CONTAINER === -->
                    <div class="story-media-container">
                        
<!-- === MEDIA === -->
{% if activity.file %}
    {% if activity.file.resource_type == 'video' %}
        <video 
            src="{{ activity.file.url }}" 
            class="story-media"
            autoplay
            loop
            playsinline
            disableRemotePlayback
            webkit-playsinline
            onclick="toggleVideoPlayPause(this, event)">
        </video>
    {% elif activity.file.resource_type == 'image' %}
        <img 
            src="{{ activity.file.url }}" 
            class="story-media"
            loading="lazy"
            onerror="this.src='{% static 'images/default-image.png' %}'">
    {% else %}
        <div style="width: 100%; height: 100%; background: var(--empty-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-primary); text-align: center;">
            <i class="fas fa-file-alt" style="font-size: 56px; color: var(--accent-color); margin-bottom: 16px;"></i>
            <span style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Document attached</span>
            <small style="font-size: 14px; color: var(--text-secondary);">{{ activity.file.name|slice:"20:" }}</small>
            <a href="{{ activity.file.url }}" target="_blank" style="color: var(--accent-color); margin-top: 16px; text-decoration: none;">
                <i class="fas fa-download"></i> Download
            </a>
        </div>
    {% endif %}
{% else %}
    <div style="width: 100%; height: 100%; background: var(--empty-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-primary); text-align: center;">
        <i class="fas fa-pencil-alt" style="font-size: 56px; color: var(--accent-color); margin-bottom: 16px;"></i>
        <span style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Text Update</span>
        <small style="font-size: 14px; color: var(--text-secondary);">Day {{ forloop.counter }} of the journey</small>
    </div>
{% endif %}
                        
                        <!-- === DAY BADGE === -->
                        <span class="day-badge">
                            <i class="fas fa-calendar-alt"></i> Day {{ forloop.counter }}
                        </span>
                        
                        <!-- === CREATOR OVERLAY === -->
                        <div class="media-meta">
                            <a href="{% url 'profile_view' username=campaign.user.user.username %}">
                                <img 
                                    src="{{ campaign.user.image.url }}" 
                                    style="width: 44px; height: 44px; border-radius: 50%; border: 2px solid var(--text-primary); object-fit: cover;"
                                    onerror="this.src='{% static 'images/default-profile.png' %}'">
                            </a>
                            <div>
                                <a href="{% url 'profile_view' username=campaign.user.user.username %}" style="color: var(--text-primary); font-weight: 700; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                                    {{ campaign.user.user.username }}
                                    {% if campaign.user.profile_verified %}
                                        <i class="fas fa-check-circle" style="color: var(--accent-color);"></i>
                                    {% endif %}
                                </a>
                                <span style="font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 4px;">
                                    <i class="far fa-clock"></i> {{ activity.timestamp|timesince }} ago
                                </span>
                            </div>
                        </div>
                        
                        <!-- === CONTENT OVERLAY === -->
                        <div class="story-content-overlay">
                            
                            <!-- Story text -->
                            <div style="font-size: 16px; line-height: 1.5; margin-bottom: 16px;">
                                {% if activity.content|length > 100 %}
                                    <div id="story-short-{{ activity.id }}" style="display: block;">
                                        {{ activity.content|truncatechars:100|safe }}
                                        <span onclick="showStoryFull('{{ activity.id }}', event)" style="color: var(--accent-color); font-weight: 600; cursor: pointer; margin-left: 4px; display: inline-block;">
                                            See More
                                        </span>
                                    </div>
                                    <div id="story-full-{{ activity.id }}" style="display: none;">
                                        {{ activity.content|safe }}
                                        <span onclick="showStoryShort('{{ activity.id }}', event)" style="color: var(--accent-color); font-weight: 600; cursor: pointer; margin-left: 4px; display: inline-block;">
                                            See Less
                                        </span>
                                    </div>
                                {% else %}
                                    {{ activity.content|safe }}
                                {% endif %}
                            </div>
                            
                            <!-- Action buttons -->
                            <div class="story-actions">
                                <div class="action-group">
                                    <!-- Love -->
                                    <span class="love-icon-story {% if user in activity.loves.all %}loved{% endif %}" 
                                          data-activity-id="{{ activity.id }}" 
                                          onclick="loveActivityStory('{{ activity.id }}', event)"
                                          style="display: flex; align-items: center; gap: 8px; color: var(--text-primary); font-size: 16px; font-weight: 600; cursor: pointer;">
                                        <i class="{% if user in activity.loves.all %}fas{% else %}far{% endif %} fa-heart" style="font-size: 24px;"></i>
                                        <span id="story-love-{{ activity.id }}">{{ activity.loves.count|format_count }}</span>
                                    </span>
                                    
                                    <!-- Comment -->
                                    <span onclick="openComments('{{ activity.id }}')" style="display: flex; align-items: center; gap: 8px; color: var(--text-primary); font-size: 16px; font-weight: 600; cursor: pointer;">
                                        <i class="far fa-comment" style="font-size: 24px;"></i>
                                        <span>{{ activity.comments.count|format_count }}</span>
                                    </span>
                                </div>
                                
                                <!-- Menu -->
                                <span onclick="openActivityMenu('{{ activity.id }}')" style="color: var(--text-primary); font-size: 24px; padding: 8px; cursor: pointer;">
                                    <i class="fas fa-ellipsis-h"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- === COMMENTS DRAWER === -->
                    <div id="comments-drawer-{{ activity.id }}" class="comments-drawer" style="display: none;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--drawer-border);">
                            <h4 style="font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; margin: 0; color: var(--drawer-text);">
                                <i class="far fa-comments" style="color: var(--drawer-secondary);"></i> Supporters
                            </h4>
                            <span onclick="closeComments('{{ activity.id }}')" style="font-size: 20px; color: var(--drawer-secondary); cursor: pointer; padding: 8px;">
                                <i class="fas fa-times"></i>
                            </span>
                        </div>
                        <div id="comments-container-{{ activity.id }}">
                            <div style="text-align: center; padding: 32px 0; color: var(--drawer-secondary);">
                                <i class="far fa-spinner fa-spin"></i> Loading...
                            </div>
                        </div>
                        <div style="margin-top: 16px; background: var(--drawer-input-bg); border-radius: 24px; padding: 12px; display: flex;">
                            <textarea id="comment-input-{{ activity.id }}" placeholder="Add your support..." rows="1" style="flex: 1; border: none; background: transparent; padding: 8px; resize: none; outline: none; color: var(--drawer-text);"></textarea>
                            <span onclick="postMobileComment('{{ activity.id }}')" style="color: var(--accent-color); font-weight: 600; padding: 8px 16px; cursor: pointer;">Post</span>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- === EMPTY STATE === -->
        <div class="empty-story">
            <i class="fas fa-compass" style="font-size: 64px; color: var(--accent-color); margin-bottom: 24px; opacity: 0.8;"></i>
            <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">Every journey starts with Day 1</h3>
            <p style="font-size: 16px; color: var(--text-secondary); margin-bottom: 32px; max-width: 280px;">
                Most people quit before they start. You're already different.
            </p>
            {% if user == campaign.user.user %}
                <a href="{% url 'create_activity' campaign_id=campaign.id %}" style="background: var(--accent-color); color: var(--text-primary); padding: 16px 32px; border-radius: 100px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 12px;">
                    <i class="fas fa-plus-circle"></i>
                    Post Day 1 update
                </a>
            {% else %}
                <div style="background: var(--button-bg); padding: 20px; border-radius: 16px; width: 100%; max-width: 300px;">
                    <p style="color: var(--text-muted); margin-bottom: 8px;">This journey hasn't started yet.</p>
                    <p style="font-size: 14px; color: var(--text-secondary);">Check back soon — the best stories take time to unfold.</p>
                </div>
            {% endif %}
        </div>
    {% endif %}
    
   
    
    <!-- === MOBILE MENU === -->
    <div id="mobile-popup-menu" class="mobile-popup-menu">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--drawer-border);">
            <span style="font-size: 16px; font-weight: 600; color: var(--drawer-text);">Activity options</span>
            <span onclick="closeMobileMenu()" style="font-size: 20px; color: var(--drawer-secondary); cursor: pointer; padding: 8px;">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="popup-menu-content"></div>
    </div>
</div>

<script>
// ===== FUNCTIONS =====
function showStoryFull(id, e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('story-short-'+id).style.display = 'none';
    document.getElementById('story-full-'+id).style.display = 'block';
}

function showStoryShort(id, e) {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('story-short-'+id).style.display = 'block';
    document.getElementById('story-full-'+id).style.display = 'none';
}

function loveActivityStory(id, e) {
    e.preventDefault();
    e.stopPropagation();
    const btn = document.querySelector(`.love-icon-story[data-activity-id="${id}"]`);
    const icon = btn.querySelector('i');
    const count = document.getElementById('story-love-'+id);
    const isLoved = btn.classList.contains('loved');
    
    if (isLoved) {
        btn.classList.remove('loved');
        icon.classList.remove('fas');
        icon.classList.add('far');
        count.textContent = Math.max(0, parseInt(count.textContent.replace(/,/g, '')) - 1).toLocaleString();
    } else {
        btn.classList.add('loved');
        icon.classList.remove('far');
        icon.classList.add('fas');
        count.textContent = (parseInt(count.textContent.replace(/,/g, '')) + 1).toLocaleString();
        btn.style.transform = 'scale(1.3)';
        setTimeout(() => btn.style.transform = 'scale(1)', 200);
    }
    
    fetch(`/love_activity/${id}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json'},
        body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(d => { if (d.love_count) count.textContent = d.love_count.toLocaleString(); })
    .catch(() => {});
}

function openComments(id) {
    document.querySelectorAll('.comments-drawer').forEach(d => d.style.display = 'none');
    const drawer = document.getElementById('comments-drawer-'+id);
    drawer.style.display = 'block';
    drawer.scrollIntoView({behavior: 'smooth'});
    
    fetch(`/get_activity_comments/${id}/?limit=5`)
        .then(r => r.json())
        .then(data => {
            let html = '';
            if (!data.comments || data.comments.length === 0) {
                html = '<div style="text-align:center; padding:32px; color:var(--drawer-secondary);">Be the first to support this milestone</div>';
            } else {
                data.comments.forEach(c => {
                    html += `<div style="display:flex; gap:12px; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid var(--drawer-border);">
                        <img src="${c.user_image || '/static/images/default-profile.png'}" style="width:36px; height:36px; border-radius:50%; object-fit:cover;">
                        <div style="flex:1;">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                                <a href="/user-profile/@${c.username}/" style="font-weight:700; color:var(--drawer-text); text-decoration:none;">${c.username}</a>
                                <span style="font-size:12px; color:var(--drawer-secondary);">${c.timestamp}</span>
                            </div>
                            <p style="font-size:14px; color:var(--drawer-text);">${escapeHtml(c.content)}</p>
                        </div>
                    </div>`;
                });
            }
            document.getElementById('comments-container-'+id).innerHTML = html;
        });
}

function closeComments(id) {
    document.getElementById('comments-drawer-'+id).style.display = 'none';
}

function postMobileComment(id) {
    const input = document.getElementById('comment-input-'+id);
    if (!input.value.trim()) return;
    
    fetch('/post_activity_comment/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
        body: JSON.stringify({activity_id: id, content: input.value.trim()})
    })
    .then(r => r.json())
    .then(() => {
        input.value = '';
        openComments(id);
        const countSpan = document.querySelector(`[onclick="openComments('${id}')"] span:last-child`);
        if (countSpan) countSpan.textContent = (parseInt(countSpan.textContent) + 1).toLocaleString();
    });
}

function openActivityMenu(id) {
    document.getElementById('popup-menu-content').innerHTML = `
        <a href="/activity/${id}/" style="display:flex; align-items:center; padding:16px; color:var(--drawer-text); text-decoration:none; border-radius:12px; font-size:16px;">
            <i class="fas fa-info-circle" style="width:24px; margin-right:16px; color:var(--drawer-secondary);"></i> View details
        </a>
        <a href="#" onclick="copyLink('${id}'); return false;" style="display:flex; align-items:center; padding:16px; color:var(--drawer-text); text-decoration:none; border-radius:12px; font-size:16px;">
            <i class="fas fa-link" style="width:24px; margin-right:16px; color:var(--drawer-secondary);"></i> Copy link
        </a>`;
    document.getElementById('mobile-popup-menu').classList.add('show');
}

function toggleMobileMenu() {
    document.getElementById('mobile-popup-menu').classList.toggle('show');
}

function closeMobileMenu() {
    document.getElementById('mobile-popup-menu').classList.remove('show');
}

function copyLink(id) {
    navigator.clipboard.writeText(window.location.origin + '/activity/' + id + '/');
    alert('Link copied!');
    closeMobileMenu();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
// Add this new function for toggling video play/pause
function toggleVideoPlayPause(video, event) {
    event.stopPropagation(); // Prevent event bubbling
    
    if (video.paused) {
        video.play();
    } else {
        video.pause();
        
        // Show pause indicator
        const container = video.closest('.story-media-container');
        const indicator = document.createElement('div');
        indicator.className = 'video-paused';
        indicator.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 10;
            pointer-events: none;
            animation: fadeOut 0.5s ease forwards;
        `;
        indicator.innerHTML = '⏸';
        
        // Add keyframes if not already present
        if (!document.querySelector('#pause-animation')) {
            const style = document.createElement('style');
            style.id = 'pause-animation';
            style.textContent = `
                @keyframes fadeOut {
                    0% { opacity: 0.8; }
                    70% { opacity: 0.8; }
                    100% { opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
        
        container.appendChild(indicator);
        
        // Remove indicator after animation
        setTimeout(() => {
            if (indicator.parentNode) {
                indicator.remove();
            }
        }, 500);
    }
}

// Update your existing video autoplay function
document.addEventListener('DOMContentLoaded', function() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const video = entry.target;
            if (entry.isIntersecting) {
                // Only autoplay if the video is not manually paused
                if (!video.hasAttribute('data-manually-paused')) {
                    video.muted = false;
                    video.play().catch(e => {
                        video.muted = true;
                        video.play().catch(() => {});
                    });
                }
            } else {
                video.pause();
            }
        });
    }, {threshold: 0.7});
    
    document.querySelectorAll('.journey-stories video').forEach(v => {
        observer.observe(v);
        v.removeAttribute('controls');
        v.loop = true;
        v.playsInline = true;
        v.setAttribute('webkit-playsinline', '');
        v.setAttribute('disableRemotePlayback', '');
        
        // Add event listener for pause to track manual pauses
        v.addEventListener('pause', () => {
            v.setAttribute('data-manually-paused', 'true');
        });
        
        v.addEventListener('play', () => {
            v.removeAttribute('data-manually-paused');
        });
    });
});

// Also update any other click handlers to not interfere with video clicks
document.addEventListener('click', function(e) {
    // If clicking on video or its container, don't trigger other actions
    if (e.target.closest('.story-media-container video') || 
        e.target.closest('.story-media-container')) {
        return;
    }
});
// Fix viewport height for mobile browsers
(function() {
    function setVH() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    
    setVH();
    window.addEventListener('resize', setVH);
    
    // Ensure body has no margin/padding
    document.body.style.margin = '0';
    document.body.style.padding = '0';
    
    // Force check on load
    window.addEventListener('load', function() {
        setVH();
        // Fix any overflow issues
        document.querySelectorAll('.journey-stories *').forEach(el => {
            if (el.scrollWidth > window.innerWidth) {
                el.style.maxWidth = '100%';
            }
        });
    });
})();

// =============================================
// MINIMAL AUTO-ENHANCEMENT FOR MEDIA
// =============================================

(function() {
    // Ultra minimal - only enhances quality without any visual overlays
    const style = document.createElement('style');
    style.textContent = `
        /* Ultra minimal enhancement - just slight quality boost */
        .story-media.auto-enhanced {
            filter: 
                contrast(1.05) 
                saturate(1.03) 
                !important;
            transition: none;
        }
        
        /* No overlays, no gradients, no effects */
        .story-media-container {
            position: relative;
            overflow: hidden;
        }
        
        /* No background overlays at all */
        .media-meta, .story-content-overlay {
            background: transparent;
            backdrop-filter: none;
        }
        
        /* Simple fade in */
        .story-media {
            animation: simpleFade 0.3s ease forwards;
            opacity: 0;
        }
        
        @keyframes simpleFade {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        /* Clean progress bar */
        .day-progress-container div:last-child div {
            background: #1DA1F2;
        }
        
        /* Simple dots */
        .dot.active {
            background: #1DA1F2;
        }
    `;
    document.head.appendChild(style);

    // Simple enhancer - only adjusts contrast and saturation slightly
    class SimpleEnhancer {
        constructor() {
            this.enhanced = new Set();
            this.init();
        }
        
        init() {
            // Enhance existing media
            document.querySelectorAll('.story-media').forEach(media => {
                this.enhance(media);
            });
            
            // Watch for new media
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) {
                            if (node.matches && node.matches('.story-media')) {
                                this.enhance(node);
                            }
                            if (node.querySelectorAll) {
                                node.querySelectorAll('.story-media').forEach(media => {
                                    this.enhance(media);
                                });
                            }
                        }
                    });
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
        
        enhance(media) {
            if (this.enhanced.has(media)) return;
            
            // Just add minimal enhancement class
            media.classList.add('auto-enhanced');
            this.enhanced.add(media);
            
            // For videos, ensure smooth playback
            if (media.tagName === 'VIDEO') {
                media.setAttribute('playsinline', '');
                media.setAttribute('webkit-playsinline', '');
                media.setAttribute('preload', 'auto');
            }
        }
    }
    
    // Initialize when ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.simpleEnhancer = new SimpleEnhancer();
        });
    } else {
        window.simpleEnhancer = new SimpleEnhancer();
    }
})();

</script>
{% endblock %}